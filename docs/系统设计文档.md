# 物业管理系统 - 系统设计文档

## 1. 技术架构

### 1.1 技术栈
- **后端**: Django 4.2 + Django REST Framework + Python 3.11
- **数据库**: PostgreSQL 15
- **缓存**: Redis（用于会话管理和缓存）
- **前端管理后台**: Django Admin + Bootstrap 5
- **微信公众号**: Vue.js 3 + Vant UI 4
- **支付**: 微信支付 JSAPI
- **消息推送**: 微信公众号模板消息
- **部署**: Docker + Nginx + Gunicorn

### 1.2 系统架构图
```
┌─────────────┐
│  微信公众号  │  ← 业主/租户
│   (H5)      │
└──────┬──────┘
       │
       ↓
┌─────────────────────────────┐
│      Nginx (反向代理)        │
└──────────────┬──────────────┘
               │
       ┌───────┴────────┐
       ↓                ↓
┌────────────┐   ┌──────────────┐
│ Django API │   │ Django Admin │  ← 财务/前台
└──────┬─────┘   └──────────────┘
       │
       ↓
┌─────────────────────────────┐
│  PostgreSQL  │  Redis       │
└─────────────────────────────┘
```

## 2. 数据库设计

### 2.1 核心数据表

#### 小区 (Community)
```python
{
    id: UUID
    name: CharField  # 小区名称（银座小区、锦尚名都）
    address: CharField  # 小区地址
    total_households: IntegerField  # 总户数
    created_at: DateTimeField
    updated_at: DateTimeField
}
```

#### 楼栋 (Building)
```python
{
    id: UUID
    community: ForeignKey(Community)  # 所属小区
    name: CharField  # 楼栋号（如：1栋、A栋）
    building_type: CharField  # 楼栋类型（高层/多层/别墅）
    created_at: DateTimeField
}
```

#### 房产 (Property)
```python
{
    id: UUID
    community: ForeignKey(Community)
    building: ForeignKey(Building)
    unit: CharField  # 单元号（如：1单元、空则为独栋）
    floor: IntegerField  # 楼层
    room_number: CharField  # 房号（如：101、1501）
    area: DecimalField  # 面积（平方米）
    property_type: CharField  # 房产类型（住宅/商业/车库）
    owner: ForeignKey(Owner, null=True)  # 业主（可为空，待售）
    status: CharField  # 状态（自住/出租/空置）
    created_at: DateTimeField
    updated_at: DateTimeField
}
```

#### 业主 (Owner)
```python
{
    id: UUID
    name: CharField  # 业主姓名
    phone: CharField  # 联系电话
    id_card: CharField  # 身份证号
    wechat_openid: CharField(null=True)  # 微信OpenID（绑定后填充）
    wechat_nickname: CharField(null=True)  # 微信昵称
    avatar_url: CharField(null=True)  # 头像
    is_verified: BooleanField  # 是否已认证
    created_at: DateTimeField
    updated_at: DateTimeField
}
```

#### 租户 (Tenant)
```python
{
    id: UUID
    name: CharField  # 租户姓名
    phone: CharField  # 联系电话
    id_card: CharField  # 身份证号
    property: ForeignKey(Property)  # 租赁的房产
    wechat_openid: CharField(null=True)  # 微信OpenID
    lease_start: DateField  # 租赁开始日期
    lease_end: DateField  # 租赁结束日期
    is_active: BooleanField  # 是否有效
    created_at: DateTimeField
}
```

#### 物业费标准 (FeeStandard)
```python
{
    id: UUID
    community: ForeignKey(Community)
    name: CharField  # 费用名称（如：住宅物业费、商业物业费）
    fee_type: CharField  # 费用类型（物业费/公摊电费/水费/其他）
    price_per_square: DecimalField  # 每平米单价
    billing_cycle: CharField  # 计费周期（月/季/年）
    created_at: DateTimeField
}
```

#### 缴费账单 (PaymentBill)
```python
{
    id: UUID
    bill_number: CharField(unique)  # 账单编号（如：202601001）
    community: ForeignKey(Community)
    property: ForeignKey(Property)  # 房产
    owner: ForeignKey(Owner)  # 业主（租户情况下也发给业主）
    fee_type: CharField  # 费用类型
    billing_period: CharField  # 账期（如：2026-01）
    amount: DecimalField  # 应缴金额
    paid_amount: DecimalField(default=0)  # 已缴金额
    status: CharField  # 状态（未缴/部分缴/已缴）
    due_date: DateField  # 应缴日期
    paid_at: DateTimeField(null=True)  # 缴费时间
    created_at: DateTimeField
}
```

#### 缴费记录 (PaymentRecord)
```python
{
    id: UUID
    bill: ForeignKey(PaymentBill)  # 关联账单
    transaction_id: CharField(unique)  # 微信支付交易号
    out_trade_no: CharField(unique)  # 商户订单号
    payer: CharField  # 缴费人（业主/租户）
    amount: DecimalField  # 缴费金额
    payment_method: CharField  # 支付方式（微信支付）
    payment_time: DateTimeField  # 支付时间
    status: CharField  # 状态（成功/退款/失败）
    created_at: DateTimeField
}
```

#### 报事记录 (MaintenanceRequest)
```python
{
    id: UUID
    request_number: CharField(unique)  # 报事编号（如：BX202601001）
    community: ForeignKey(Community)
    property: ForeignKey(Property)
    reporter: CharField  # 报事人（业主/租户）
    reporter_phone: CharField  # 联系电话
    category: CharField  # 类别（电工/水工/土木/其他）
    description: TextField  # 问题描述
    images: JSONField  # 图片列表（可多图）
    status: CharField  # 状态（待派单/处理中/待验收/已完成）
    priority: CharField  # 优先级（一般/紧急/非常紧急）
    assigned_to: CharField(null=True)  # 指派给（如：电工张三）
    assigned_at: DateTimeField(null=True)  # 派单时间
    completed_at: DateTimeField(null=True)  # 完成时间
    result_images: JSONField  # 处理结果图片
    result_description: TextField(null=True)  # 处理结果说明
    created_at: DateTimeField
    updated_at: DateTimeField
}
```

#### 操作日志 (OperationLog)
```python
{
    id: UUID
    operator: CharField  # 操作人
    action: CharField  # 操作类型
    module: CharField  # 模块
    description: TextField  # 操作描述
    ip_address: CharField  # IP地址
    created_at: DateTimeField
}
```

### 2.2 ER 关系图
```
Community (1) ---- (N) Building
Community (1) ---- (N) Property
Community (1) ---- (N) FeeStandard
Community (1) ---- (N) PaymentBill

Building (1) ---- (N) Property

Owner (1) ---- (N) Property
Owner (1) ---- (N) PaymentBill

Property (1) ---- (N) PaymentBill
Property (1) ---- (N) MaintenanceRequest
Property (1) ---- (N) Tenant

PaymentBill (1) ---- (N) PaymentRecord

Tenant (1) ---- (N) PaymentBill (租户代缴)
```

## 3. 功能模块设计

### 3.1 物业缴费模块（优先级1）

#### 管理后台功能
1. **账单管理**
   - 批量生成账单（按小区/楼栋/房产）
   - 账单查询（支持多条件筛选）
   - 账单导出（Excel）
   - 手动创建/编辑/删除账单
   - 账单统计（应收/实收/欠费）

2. **费用标准管理**
   - 设置不同类型的物业费标准
   - 按房产类型设置不同费率

3. **缴费记录**
   - 查看所有缴费记录
   - 退款处理
   - 导出缴费报表

#### 微信公众号功能
1. **我的房产**
   - 查看名下所有房产
   - 切换当前房产

2. **账单查询**
   - 查看当前房产所有账单
   - 按月份筛选
   - 账单详情

3. **在线缴费**
   - 选择未缴账单
   - 微信支付
   - 查看缴费记录

4. **消息通知**
   - 新账单推送
   - 缴费成功通知

### 3.2 物业报事模块（优先级2）

#### 管理后台功能
1. **报事管理**
   - 查看所有报事记录
   - 派单（指派给维修人员）
   - 更新处理状态
   - 上传处理结果图片
   - 报事统计

2. **通知功能**
   - 微信群通知（集成企业微信机器人）
   - 短信通知（可选）

#### 微信公众号功能
1. **我要报事**
   - 选择报事房产
   - 选择报事类别
   - 填写问题描述
   - 上传图片
   - 提交报事

2. **报事记录**
   - 查看我的报事记录
   - 查看处理进度
   - 查看处理结果
   - 评价服务

3. **消息通知**
   - 报事受理通知
   - 维修人员出发通知
   - 处理完成通知

## 4. 微信公众号集成

### 4.1 微信授权登录
```
1. 用户关注公众号
2. 点击菜单"我的服务"
3. 跳转到授权页面
4. 获取用户 OpenID
5. 引导用户绑定（输入姓名+身份证号+房号）
6. 验证身份后绑定成功
```

### 4.2 微信支付流程
```
1. 用户选择账单
2. 调用统一下单 API
3. 返回支付参数
4. 调起微信支付
5. 支付结果回调
6. 更新账单状态
7. 发送模板消息通知
```

### 4.3 模板消息
- 账单生成通知
- 缴费成功通知
- 报事提交成功
- 报事处理进度更新

## 5. 权限设计

### 5.1 用户角色
- **超级管理员**: 全部权限
- **财务**: 账单管理、缴费记录、费用标准
- **前台**: 报事管理、业主信息查询、数据统计查看
- **业主**: 查看自己的房产、账单、报事
- **租户**: 查看租赁房产的账单、报事

### 5.2 数据权限
- **小区隔离**: 不同小区的数据隔离
- **业主数据保护**: 敏感信息加密存储

## 6. 安全设计

### 6.1 数据安全
- 手机号脱敏显示
- 身份证号加密存储
- 支付数据加密传输
- 操作日志记录

### 6.2 接口安全
- JWT Token 认证
- API 限流
- SQL 注入防护（Django ORM）
- XSS 防护

## 7. 项目结构

```
property_management/
├── apps/
│   ├── core/              # 核心配置
│   ├── community/         # 小区管理
│   ├── property/          # 房产管理
│   ├── owner/             # 业主管理
│   ├── payment/           # 缴费管理
│   ├── maintenance/       # 报事管理
│   └── wechat/            # 微信集成
├── config/                # 配置文件
│   ├── settings/
│   │   ├── base.py
│   │   ├── development.py
│   │   └── production.py
│   ├── urls.py
│   └── wsgi.py
├── static/
├── media/
├── templates/
├── requirements/
│   ├── base.txt
│   ├── development.txt
│   └── production.txt
├── manage.py
├── Dockerfile
└── docker-compose.yml
```

## 8. 开发计划

### 阶段一：基础框架 + 缴费功能
1. Django 项目初始化
2. 数据库模型创建（小区、房产、业主、账单）
3. Django Admin 后台开发
4. 微信公众号授权登录
5. 账单查询和缴费功能

### 阶段二：报事功能
1. 报事数据模型
2. 报事管理后台
3. 微信报事功能
4. 消息推送

### 阶段三：其他功能
1. 装修申请
2. 来访登记
3. 数据统计报表

## 9. 部署方案

### 开发环境
- 本地运行：`python manage.py runserver`
- 数据库：SQLite

### 生产环境
- Docker 部署
- Nginx 反向代理
- Gunicorn 应用服务器
- PostgreSQL 数据库
- Redis 缓存
- 云服务器（阿里云/腾讯云）

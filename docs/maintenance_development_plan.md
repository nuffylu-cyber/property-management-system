# 报事管理模块开发计划

## 📅 计划时间
2026-01-20 开始

## 🎯 模块概述

**模块名称：** 报事管理 (Maintenance Management)

**功能范围：**
- 报事申请管理
- 工单处理流程
- 报事记录查看
- 处理日志追踪

---

## 📊 现有代码分析

### 数据模型 ✅ 已完成

**文件：** `apps/maintenance/models.py`

#### 1. MaintenanceRequest - 报事记录模型

**字段说明：**
```python
id                  # UUID主键
request_number      # 报事编号（自动生成：BX+年月日+4位随机数）
community           # 所属小区（外键）
property            # 房产（外键）
reporter            # 报事人
reporter_phone      # 联系电话
category            # 报事类别（电工/水工/土木/电梯/清洁/安保/其他）
description         # 问题描述
images              # 图片列表（JSON）
status              # 状态（待派单/已派单/处理中/已完成/已关闭）
priority            # 优先级（一般/紧急/非常紧急）
assigned_to         # 指派给
assigned_at         # 派单时间
started_at          # 开始处理时间
completed_at        # 完成时间
result_images       # 处理结果图片
result_description  # 处理结果说明
rating              # 评分(1-5)
feedback            # 用户反馈
```

#### 2. MaintenanceLog - 报事处理日志模型

**字段说明：**
```python
id                  # UUID主键
request             # 报事记录（外键）
operator            # 操作人
action              # 操作类型
description         # 操作说明
images              # 图片（JSON）
created_at          # 创建时间
```

---

## 🎨 前端页面规划

### 1. 报事列表页

**布局：**
```
+----------------------------------+
|  报事管理                         |
+----------------------------------+
|  [+ 新增报事]  [筛选] [搜索]      |
+----------------------------------+
|  报事编号 | 房号 | 报事类别 | 状态 |
|  优先级  | 报事人 | 时间 | 操作 |
+----------------------------------+
```

**功能需求：**
- ✅ 列表展示所有报事记录
- ✅ 状态筛选（全部/待派单/已派单/处理中/已完成/已关闭）
- ✅ 优先级筛选
- ✅ 小区筛选
- ✅ 搜索（报事编号、房号、报事人）
- ✅ 分页功能
- ✅ 查看详情
- ✅ 状态转换按钮

**显示字段：**
- 报事编号（等宽字体）
- 房号（两行显示：完整地址 + 楼层-房号）
- 报事类别（彩色标签）
- 优先级（颜色标记：一般-灰色、紧急-橙色、非常紧急-红色）
- 报事人
- 报事时间
- 状态（徽章样式）
- 操作按钮

---

### 2. 报事详情页/模态框

**功能需求：**
- ✅ 显示完整的报事信息
- ✅ 查看处理日志
- ✅ 状态转换操作
- ✅ 指派工程师
- ✅ 上传处理结果
- ✅ 用户评价

**信息分组：**

#### 基本信息
- 报事编号
- 房产信息
- 报事人 + 联系电话
- 报事类别 + 优先级
- 问题描述
- 报事图片（轮播展示）
- 报事时间

#### 处理信息
- 当前状态
- 指派工程师
- 派单时间
- 开始处理时间
- 完成时间
- 处理结果说明
- 处理结果图片

#### 处理日志
- 操作时间
- 操作人
- 操作类型
- 操作说明
- 操作图片

---

### 3. 新增/编辑报事表单

**表单字段：**
```
基本信息：
- 所属小区 *       [下拉选择]
- 房产 *           [级联选择：小区 → 楼栋 → 房产]
- 报事人 *         [文本输入]
- 联系电话 *       [电话输入]
- 报事类别 *       [下拉选择]
- 优先级 *         [下拉选择：一般/紧急/非常紧急]
- 问题描述 *       [多行文本]
- 报事图片         [多图上传]

处理信息（编辑时显示）：
- 指派给           [员工选择]
- 处理结果说明     [多行文本]
- 处理结果图片     [多图上传]
- 用户评分         [星级评分]
- 用户反馈         [多行文本]
```

---

## 🔄 业务流程设计

### 报事处理流程

```
[待派单] → [已派单] → [处理中] → [已完成] → [已关闭]
           ↓
      指派工程师

可选路径：
[待派单] → [已关闭]（取消报事）
[已完成] → [已关闭]（用户确认）
[已完成] → [处理中]（返工）
```

### 状态转换规则

| 当前状态 | 可转换状态 | 触发条件 |
|---------|-----------|---------|
| 待派单 | 已派单、已关闭 | 指派工程师或取消 |
| 已派单 | 处理中 | 工程师开始处理 |
| 处理中 | 已完成 | 工程师完成处理 |
| 已完成 | 已关闭、处理中 | 用户确认或返工 |
| 已关闭 | - | 终态 |

---

## 🔌 API接口规划

### 报事管理API

```
# 报事记录CRUD
GET    /api/maintenance/requests/              # 获取报事列表
POST   /api/maintenance/requests/              # 创建报事
GET    /api/maintenance/requests/{id}/         # 获取报事详情
PUT    /api/maintenance/requests/{id}/         # 更新报事
DELETE /api/maintenance/requests/{id}/         # 删除报事

# 状态转换API
POST   /api/maintenance/requests/{id}/assign/       # 指派工程师
POST   /api/maintenance/requests/{id}/start/        # 开始处理
POST   /api/maintenance/requests/{id}/complete/     # 完成处理
POST   /api/maintenance/requests/{id}/close/        # 关闭报事
POST   /api/maintenance/requests/{id}/reopen/       # 重新打开

# 处理日志API
GET    /api/maintenance/logs/?request_id={id}       # 获取处理日志
POST   /api/maintenance/logs/                      # 添加处理日志
```

---

## 📋 开发任务清单

### Phase 1: 基础功能（优先级：高）

#### 1.1 报事列表页
- [ ] 创建报事列表页面模板
- [ ] 实现报事列表展示
- [ ] 添加状态筛选功能
- [ ] 添加优先级筛选
- [ ] 添加搜索功能
- [ ] 实现分页功能
- [ ] 添加查看详情按钮

#### 1.2 报事详情功能
- [ ] 创建报事详情模态框
- [ ] 显示基本信息
- [ ] 显示处理信息
- [ ] 显示处理日志
- [ ] 添加状态转换按钮

#### 1.3 新增报事表单
- [ ] 创建报事表单模板
- [ ] 实现小区级联选择
- [ ] 实现房产级联选择
- [ ] 添加表单验证
- [ ] 实现图片上传功能

#### 1.4 JavaScript功能模块
- [ ] 创建MaintenanceCRUD对象
- [ ] 实现新增报事功能
- [ ] 实现编辑报事功能
- [ ] 实现删除报事功能
- [ ] 实现查看详情功能

---

### Phase 2: 工单处理功能（优先级：高）

#### 2.1 状态转换功能
- [ ] 指派工程师功能
- [ ] 开始处理功能
- [ ] 完成处理功能
- [ ] 关闭报事功能
- [ ] 重新打开功能（返工）

#### 2.2 处理结果管理
- [ ] 上传处理结果图片
- [ ] 填写处理结果说明
- [ ] 用户评分功能
- [ ] 用户反馈功能

#### 2.3 处理日志功能
- [ ] 自动记录状态变更
- [ ] 手动添加处理日志
- [ ] 显示日志时间线
- [ ] 日志图片展示

---

### Phase 3: 增强功能（优先级：中）

#### 3.1 统计功能
- [ ] 报事统计看板
- [ ] 按类别统计
- [ ] 按状态统计
- [ ] 处理时长统计
- [ ] 满意度统计

#### 3.2 批量操作
- [ ] 批量指派
- [ ] 批量关闭
- [ ] 批量导出

#### 3.3 通知功能
- [ ] 新报事通知
- [ ] 状态变更通知
- [ ] 完成处理通知

---

### Phase 4: 优化功能（优先级：低）

#### 4.1 性能优化
- [ ] 列表分页优化
- [ ] 图片懒加载
- [ ] 缓存优化

#### 4.2 用户体验优化
- [ ] 拖拽排序
- [ ] 快捷键操作
- [ ] 移动端适配

---

## 🎨 UI设计要点

### 颜色方案

**报事类别颜色：**
- 电工：蓝色 `#3B82F6`
- 水工：青色 `#06B6D4`
- 土木：橙色 `#F97316`
- 电梯：紫色 `#8B5CF6`
- 清洁：绿色 `#10B981`
- 安保：红色 `#EF4444`
- 其他：灰色 `#6B7280`

**优先级颜色：**
- 一般：灰色 `#6B7280`
- 紧急：橙色 `#F97316`
- 非常紧急：红色 `#EF4444`

**状态徽章：**
- 待派单：灰色
- 已派单：蓝色
- 处理中：橙色
- 已完成：绿色
- 已关闭：深灰色

---

## 🔧 技术实现要点

### 1. 状态机模式

使用状态机模式管理报事状态转换：

```javascript
const STATE_MACHINE = {
    pending: ['assigned', 'closed'],
    assigned: ['processing'],
    processing: ['completed'],
    completed: ['closed', 'processing'],  // 可返工
    closed: []  // 终态
};

function canTransition(currentState, newState) {
    return STATE_MACHINE[currentState].includes(newState);
}
```

### 2. 处理日志时间线

使用时间线组件展示处理日志：

```html
<div class="timeline">
    <div class="timeline-item">
        <div class="timeline-dot"></div>
        <div class="timeline-content">
            <div class="timeline-time">2026-01-20 14:30</div>
            <div class="timeline-action">指派工程师</div>
            <div class="timeline-desc">指派给张工程师处理</div>
        </div>
    </div>
</div>
```

### 3. 图片上传组件

使用现有的图片上传逻辑，支持：
- 多图上传
- 预览功能
- 删除功能
- 拖拽排序

---

## 📝 参考缴费管理模块

### 可复用的组件

1. **UniversalCRUD** - 通用CRUD管理器
2. **级联选择** - 小区→楼栋→房产
3. **图片上传** - 多图上传和预览
4. **模态框** - 详情展示
5. **筛选器** - 多条件筛选
6. **分页器** - 统一的分页组件

### 可复用的模式

1. **JavaScript模块化** - `Window.{Module}CRUD`
2. **动态表单初始化** - `onLoad`回调
3. **前后端双重验证**
4. **错误提示机制**
5. **数据同步逻辑**

---

## ✅ 验收标准

### 功能完整性
- [ ] 所有CRUD操作正常
- [ ] 状态转换符合业务规则
- [ ] 处理日志自动记录
- [ ] 图片上传正常工作

### 用户体验
- [ ] 操作流程顺畅
- [ ] 错误提示友好
- [ ] 界面美观整洁
- [ ] 响应及时

### 代码质量
- [ ] 结构清晰易懂
- [ ] 注释完整准确
- [ ] 遵循开发规范
- [ ] 无明显bug

---

## 📅 开发时间估算

| 阶段 | 任务 | 预计时间 |
|------|------|---------|
| Phase 1 | 基础功能 | 2-3小时 |
| Phase 2 | 工单处理功能 | 2-3小时 |
| Phase 3 | 增强功能 | 1-2小时 |
| Phase 4 | 优化功能 | 1小时 |
| 测试 | 功能测试和调试 | 1小时 |
| **总计** | | **7-10小时** |

---

## 🎯 下一步行动

1. ✅ 复习缴费管理模块的实现
2. ✅ 理解报事管理的业务流程
3. ⏳ 创建报事列表页面模板
4. ⏳ 实现报事CRUD功能
5. ⏳ 实现状态转换功能

---

**备注：** 本文档为报事管理模块开发的完整规划，参考了缴费管理模块的成功经验。

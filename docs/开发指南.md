# 开发指南

## 环境搭建

### 1. 安装 Python
```bash
# Windows
# 访问 https://www.python.org/downloads/ 下载安装

# macOS
brew install python@3.11

# Linux (Ubuntu/Debian)
sudo apt-get update
sudo apt-get install python3.11 python3.11-venv python3-pip
```

### 2. 安装 PostgreSQL
```bash
# macOS
brew install postgresql@15
brew services start postgresql@15

# Linux (Ubuntu/Debian)
sudo apt-get install postgresql-15
sudo systemctl start postgresql

# Windows
# 访问 https://www.postgresql.org/download/ 下载安装
```

### 3. 安装 Redis
```bash
# macOS
brew install redis
brew services start redis

# Linux (Ubuntu/Debian)
sudo apt-get install redis-server
sudo systemctl start redis

# Windows
# 下载 Redis for Windows 或使用 WSL
```

### 4. 安装 Git
```bash
# macOS
brew install git

# Linux (Ubuntu/Debian)
sudo apt-get install git

# Windows
# 访问 https://git-scm.com/download/win 下载安装
```

## 项目初始化

### 1. 克隆项目
```bash
git clone <repository-url>
cd property-management
```

### 2. 创建虚拟环境
```bash
python -m venv venv

# 激活虚拟环境
# macOS/Linux:
source venv/bin/activate

# Windows:
venv\Scripts\activate
```

### 3. 安装依赖
```bash
pip install --upgrade pip
pip install -r requirements/development.txt
```

### 4. 配置环境变量
```bash
cp .env.example .env
```

编辑 `.env` 文件：
```env
SECRET_KEY=your-secret-key-here
DEBUG=True
DB_NAME=property_management
DB_USER=postgres
DB_PASSWORD=your-password
DB_HOST=localhost
DB_PORT=5432
```

### 5. 创建数据库
```bash
# PostgreSQL
createdb property_management

# 或使用 psql
psql -U postgres
CREATE DATABASE property_management;
\q
```

### 6. 数据库迁移
```bash
python manage.py makemigrations
python manage.py migrate
```

### 7. 创建超级用户
```bash
python manage.py createsuperuser
```

### 8. 启动开发服务器
```bash
python manage.py runserver
```

访问：
- http://localhost:8000/admin
- http://localhost:8000/swagger/

## 开发工作流

### 1. 创建新功能
```bash
# 创建新分支
git checkout -b feature/your-feature-name

# 开发代码
# ...

# 查看修改
git status
git diff

# 添加文件
git add .

# 提交代码
git commit -m "Add your feature"

# 推送到远程
git push origin feature/your-feature-name
```

### 2. 创建新的 Django 应用
```bash
python manage.py startapp appname apps/appname

# 在 apps/appname/apps.py 中配置应用名称
# 在 config/settings/base.py 中添加应用
# 在 config/urls.py 中添加路由
```

### 3. 创建模型
```bash
# 编辑 apps/yourapp/models.py

# 创建迁移
python manage.py makemigrations yourapp

# 查看迁移 SQL
python manage.py sqlmigrate yourapp 0001

# 执行迁移
python manage.py migrate

# 在 apps/yourapp/admin.py 中注册模型
```

### 4. 创建 API
```bash
# 编辑 apps/yourapp/serializers.py
# 编辑 apps/yourapp/views.py
# 编辑 apps/yourapp/urls.py

# 测试 API
# 访问 http://localhost:8000/swagger/
```

## 代码规范

### Python 代码风格
使用 Black 格式化代码：
```bash
black .
```

使用 Flake8 检查代码：
```bash
flake8 .
```

### 命名规范
- 类名：大驼峰（PascalCase）- `class MyModel`
- 函数名：小写+下划线（snake_case）- `def my_function`
- 变量名：小写+下划线（snake_case）- `my_variable`
- 常量：大写+下划线（UPPER_CASE）- `MY_CONSTANT`

### 注释规范
```python
def function_name(param1, param2):
    """
    函数功能的简短描述

    详细说明函数的功能、参数、返回值等

    Args:
        param1 (type): 参数1的说明
        param2 (type): 参数2的说明

    Returns:
        type: 返回值的说明

    Raises:
        Exception: 异常说明
    """
    pass
```

## 测试

### 运行测试
```bash
# 运行所有测试
pytest

# 运行特定应用的测试
pytest apps/yourapp/

# 查看测试覆盖率
pytest --cov=apps --cov-report=html
```

### 编写测试
```python
# apps/yourapp/tests.py
from django.test import TestCase
from rest_framework.test import APIClient
from apps.yourapp.models import YourModel

class YourModelTest(TestCase):
    def setUp(self):
        self.client = APIClient()
        # 设置测试数据

    def test_create_model(self):
        # 测试创建模型
        obj = YourModel.objects.create(field1='value1')
        self.assertEqual(obj.field1, 'value1')
```

## 调试

### Django Debug Toolbar
已集成 Django Debug Toolbar，访问 `/admin/` 时会在右侧显示调试信息。

### Python 调试
```python
# 在代码中插入断点
import pdb; pdb.set_trace()

# 或使用 ipdb
import ipdb; ipdb.set_trace()
```

### 日志查看
```bash
# 查看日志
tail -f logs/django.log

# 或在代码中记录日志
import logging
logger = logging.getLogger(__name__)
logger.info('Info message')
logger.error('Error message')
```

## 数据库操作

### 查询数据
```python
# 获取所有数据
objects = Model.objects.all()

# 过滤数据
objects = Model.objects.filter(field='value')

# 获取单个对象
obj = Model.objects.get(id=1)

# 排序
objects = Model.objects.order_by('-created_at')

# 限制数量
objects = Model.objects.all()[:10]
```

### 创建数据
```python
# 方法1
obj = Model.objects.create(field1='value1', field2='value2')

# 方法2
obj = Model(field1='value1', field2='value2')
obj.save()
```

### 更新数据
```python
# 方法1
obj = Model.objects.get(id=1)
obj.field1 = 'new_value'
obj.save()

# 方法2：批量更新
Model.objects.filter(field='value').update(field1='new_value')
```

### 删除数据
```python
# 方法1
obj = Model.objects.get(id=1)
obj.delete()

# 方法2：批量删除
Model.objects.filter(field='value').delete()
```

## 常见问题

### 1. 迁移冲突
```bash
# 合并迁移
python manage.py makemigrations --merge

# 重置迁移（慎用）
python manage.py migrate yourapp zero
python manage.py makemigrations yourapp
python manage.py migrate yourapp
```

### 2. 静态文件加载失败
```bash
# 收集静态文件
python manage.py collectstatic

# 开发环境不需要，生产环境需要
```

### 3. 数据库连接失败
- 检查 PostgreSQL 是否运行
- 检查 `.env` 配置是否正确
- 检查数据库是否已创建

### 4. 权限错误
```bash
# 确保使用正确的用户权限
python manage.py shell
>>> from django.contrib.auth.models import User
>>> user = User.objects.get(username='admin')
>>> user.is_staff = True
>>> user.is_superuser = True
>>> user.save()
```

## 部署到生产环境

### 1. 修改配置
编辑 `.env`：
```env
DEBUG=False
ALLOWED_HOSTS=yourdomain.com,www.yourdomain.com
DB_NAME=production_db
# ...
```

### 2. 收集静态文件
```bash
python manage.py collectstatic --noinput
```

### 3. 使用 Docker
```bash
docker-compose -f docker-compose.yml up -d
```

### 4. 配置 Nginx
编辑 `nginx.conf`，配置 SSL 证书。

## 参考资料

- [Django 官方文档](https://docs.djangoproject.com/)
- [Django REST Framework 文档](https://www.django-rest-framework.org/)
- [PostgreSQL 文档](https://www.postgresql.org/docs/)
- [Redis 文档](https://redis.io/docs/)
- [微信公众号开发文档](https://developers.weixin.qq.com/doc/)

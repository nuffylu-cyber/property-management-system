{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>账户管理 - 物业管理系统</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/admin.css' %}">
    <style>
        .role-card {
            background: #fff;
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
            cursor: pointer;
        }
        .role-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        .role-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }
        .role-super-admin .role-icon { background: var(--error-light); color: var(--error); }
        .role-admin .role-icon { background: var(--warning-light); color: var(--warning); }
        .role-finance .role-icon { background: var(--info-light); color: var(--info); }
        .role-receptionist .role-icon { background: var(--primary-light); color: var(--primary-600); }
        .role-engineering .role-icon { background: var(--success-light); color: var(--success); }
        .role-owner .role-icon { background: var(--gray-100); color: var(--gray-600); }
        .role-tenant .role-icon { background: var(--gray-100); color: var(--gray-500); }

        .permission-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--gray-50);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }
        .permission-checkboxes {
            display: flex;
            gap: 16px;
        }
        .permission-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }
        .permission-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 侧边栏 -->
        {% include "components/sidebar.html" %}

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 顶部栏 -->
            {% include "components/header.html" %}

            <!-- 内容区域 -->
            <div class="content">
                <!-- 页面头部 -->
                <div class="page-header animate-in">
                    <div>
                        <h1 class="page-title">账户管理</h1>
                        <p class="page-subtitle">管理系统账号和角色权限</p>
                    </div>
                    <button class="btn btn-primary" onclick="AccountCRUD.create()">
                        <i class="ri-user-add-line"></i>
                        创建账号
                    </button>
                </div>

                <!-- Tab切换 -->
                <div class="tabs">
                    <button class="tab active" onclick="switchAccountTab(this, 'roles')">
                        <i class="ri-user-line"></i>
                        角色管理
                    </button>
                    <button class="tab" onclick="switchAccountTab(this, 'permissions')">
                        <i class="ri-lock-line"></i>
                        权限配置
                    </button>
                    <button class="tab" onclick="switchAccountTab(this, 'accounts')">
                        <i class="ri-admin-line"></i>
                        账号列表
                    </button>
                </div>

                <!-- 角色管理Tab -->
                <div id="tab-roles" class="tab-content">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 24px;">
                        {% for role_key, role_info in role_stats.items %}
                        <div class="role-card role-{{ role_key }}" onclick="AccountCRUD.viewRoleUsers('{{ role_key }}', '{{ role_info.name }}')">
                            <div class="role-icon">
                                {% if role_key == 'super_admin' %}<i class="ri-shield-keyhole-line"></i>
                                {% elif role_key == 'admin' %}<i class="ri-admin-line"></i>
                                {% elif role_key == 'finance' %}<i class="ri-money-cny-circle-line"></i>
                                {% elif role_key == 'receptionist' %}<i class="ri-service-line"></i>
                                {% elif role_key == 'engineering' %}<i class="ri-tools-line"></i>
                                {% elif role_key == 'owner' %}<i class="ri-home-user-line"></i>
                                {% elif role_key == 'tenant' %}<i class="ri-user-smile-line"></i>
                                {% endif %}
                            </div>
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">{{ role_info.name }}</h3>
                            <p style="font-size: 14px; color: var(--gray-500);">{{ role_info.count }} 个账号</p>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- 角色说明 -->
                    <div style="background: #fff; border-radius: var(--radius-lg); padding: 24px; margin-top: 24px; box-shadow: var(--shadow-sm);">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">角色权限说明</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <div style="padding: 16px; background: var(--error-light); border-radius: var(--radius-md); border-left: 4px solid var(--error);">
                                <h4 style="font-size: 15px; font-weight: 600; color: var(--error); margin-bottom: 8px;">超级管理员</h4>
                                <p style="font-size: 13px; color: var(--gray-700);">拥有系统所有权限，可以管理所有模块、创建账号、配置系统参数</p>
                            </div>
                            <div style="padding: 16px; background: var(--warning-light); border-radius: var(--radius-md); border-left: 4px solid var(--warning);">
                                <h4 style="font-size: 15px; font-weight: 600; color: var(--warning); margin-bottom: 8px;">管理员</h4>
                                <p style="font-size: 13px; color: var(--gray-700);">可以管理小区、房产、报事等信息，但不能操作系统设置和账号管理</p>
                            </div>
                            <div style="padding: 16px; background: var(--info-light); border-radius: var(--radius-md); border-left: 4px solid var(--info);">
                                <h4 style="font-size: 15px; font-weight: 600; color: var(--info); margin-bottom: 8px;">财务</h4>
                                <p style="font-size: 13px; color: var(--gray-700);">可以查看和管理缴费信息、生成账单、查看财务报表</p>
                            </div>
                            <div style="padding: 16px; background: var(--primary-light); border-radius: var(--radius-md); border-left: 4px solid var(--primary-600);">
                                <h4 style="font-size: 15px; font-weight: 600; color: var(--primary-600); margin-bottom: 8px;">前台</h4>
                                <p style="font-size: 13px; color: var(--gray-700);">负责日常接待、接听报事电话、登记报事信息、查看业主信息</p>
                            </div>
                            <div style="padding: 16px; background: var(--success-light); border-radius: var(--radius-md); border-left: 4px solid var(--success);">
                                <h4 style="font-size: 15px; font-weight: 600; color: var(--success); margin-bottom: 8px;">工程部</h4>
                                <p style="font-size: 13px; color: var(--gray-700);">查看和处理报事工单、更新维修进度、完成维修任务</p>
                            </div>
                            <div style="padding: 16px; background: var(--gray-100); border-radius: var(--radius-md); border-left: 4px solid var(--gray-500);">
                                <h4 style="font-size: 15px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">业主/租户</h4>
                                <p style="font-size: 13px; color: var(--gray-700);">查看个人房产信息、缴费记录、提交报事申请</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 权限配置Tab -->
                <div id="tab-permissions" class="tab-content" style="display: none;">
                    <div style="background: #fff; border-radius: var(--radius-lg); padding: 24px; margin-top: 24px; box-shadow: var(--shadow-sm);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h3 style="font-size: 18px; font-weight: 600;">权限配置</h3>
                            <select id="roleSelector" style="padding: 8px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;" onchange="AccountCRUD.loadPermissions(this.value)">
                                {% for role_key, role_info in role_stats.items %}
                                <option value="{{ role_key }}">{{ role_info.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div id="permissionsContainer">
                            <!-- 按模块分组显示权限 -->
                            {% regroup permissions by module as module_groups %}
                            {% for module in module_groups %}
                            <div style="margin-bottom: 32px;" data-module="{{ module.grouper }}">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--gray-200);">
                                    <h4 style="font-size: 16px; font-weight: 600; margin: 0;">{{ module.grouper }}</h4>
                                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px; color: var(--primary-600); font-weight: 500;">
                                        <input type="checkbox" class="select-all-module" data-module="{{ module.grouper }}" onchange="AccountCRUD.toggleModulePermissions('{{ module.grouper }}', this.checked)">
                                        全选
                                    </label>
                                </div>
                                {% for perm in module.list %}
                                <div class="permission-item">
                                    <div>
                                        <div style="font-size: 14px; font-weight: 500; margin-bottom: 4px;">{{ perm.name }}</div>
                                        <div style="font-size: 12px; color: var(--gray-500);">{{ perm.description|default:perm.code }}</div>
                                    </div>
                                    <div class="permission-checkboxes">
                                        <label class="permission-checkbox">
                                            <input type="checkbox" data-permission="{{ perm.code }}" data-action="view" data-module="{{ module.grouper }}" checked>
                                            查看
                                        </label>
                                        <label class="permission-checkbox">
                                            <input type="checkbox" data-permission="{{ perm.code }}" data-action="create" data-module="{{ module.grouper }}">
                                            创建
                                        </label>
                                        <label class="permission-checkbox">
                                            <input type="checkbox" data-permission="{{ perm.code }}" data-action="edit" data-module="{{ module.grouper }}">
                                            编辑
                                        </label>
                                        <label class="permission-checkbox">
                                            <input type="checkbox" data-permission="{{ perm.code }}" data-action="delete" data-module="{{ module.grouper }}">
                                            删除
                                        </label>
                                        <label class="permission-checkbox">
                                            <input type="checkbox" data-permission="{{ perm.code }}" data-action="export" data-module="{{ module.grouper }}">
                                            导出
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>

                        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--gray-200); text-align: right;">
                            <button class="btn btn-secondary" onclick="location.reload()">重置</button>
                            <button class="btn btn-primary" onclick="AccountCRUD.savePermissions()">
                                <i class="ri-save-line"></i>
                                保存权限配置
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 账号列表Tab -->
                <div id="tab-accounts" class="tab-content" style="display: none;">
                    <div class="table-container" style="margin-top: 24px;">
                        <div class="table-toolbar">
                            <div class="table-filters">
                                <div class="search-input">
                                    <i class="ri-search-line"></i>
                                    <input type="text" id="accountSearchInput" placeholder="搜索用户名、手机号..." onkeyup="AccountManager.filter()">
                                </div>
                                <select class="filter-select" id="accountRoleFilter" onchange="AccountManager.filter()">
                                    <option value="">所有角色</option>
                                    {% for role_key, role_info in role_stats.items %}
                                    <option value="{{ role_key }}">{{ role_info.name }}</option>
                                    {% endfor %}
                                </select>
                                <select class="filter-select" id="accountStatusFilter" onchange="AccountManager.filter()">
                                    <option value="">所有状态</option>
                                    <option value="active">已激活</option>
                                    <option value="inactive">已禁用</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="AccountManager.reset()">
                                    <i class="ri-refresh-line"></i>
                                    重置
                                </button>
                                <button class="btn btn-success" onclick="AccountManager.export()">
                                    <i class="ri-download-line"></i>
                                    导出
                                </button>
                            </div>
                        </div>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th>用户名</th>
                                    <th>角色</th>
                                    <th>联系电话</th>
                                    <th>状态</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="accountsTableBody">
                                {% for user in users %}
                                <tr data-user-id="{{ user.id }}" data-username="{{ user.username }}" data-role="{{ user.role }}" data-phone="{{ user.phone|default:'' }}" data-is-active="{{ user.is_active|lower }}">
                                    <td>
                                        <div style="font-weight: 500;">{{ user.username }}</div>
                                        <div style="font-size: 12px; color: var(--gray-400);">{{ user.get_full_name|default:"-" }}</div>
                                    </td>
                                    <td>
                                        <span class="tag tag-{{ user.role }}">
                                            {{ user.get_role_display }}
                                        </span>
                                    </td>
                                    <td>{{ user.phone|default:"-" }}</td>
                                    <td>
                                        {% if user.is_active %}
                                        <span class="tag tag-success">已激活</span>
                                        {% else %}
                                        <span class="tag tag-error">已禁用</span>
                                        {% endif %}
                                    </td>
                                    <td style="font-size: 13px; color: var(--gray-600);">{{ user.created_at|date:"Y-m-d" }}</td>
                                    <td>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn-icon" onclick="AccountCRUD.edit('{{ user.id }}')">
                                                <i class="ri-edit-line"></i>
                                            </button>
                                            {% if user.username != request.user.username %}
                                            <button class="btn-icon btn-icon-error" onclick="AccountCRUD.delete('{{ user.id }}')">
                                                <i class="ri-delete-bin-line"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray-500);">
                                        <i class="ri-inbox-line" style="font-size: 48px; display: block; margin-bottom: 16px;"></i>
                                        暂无账号
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 创建/编辑账号模态框 -->
    <div id="accountModalOverlay" class="modal-overlay">
        <div class="modal modal-md">
            <div class="modal-header">
                <h2 class="modal-title" id="accountModalTitle">创建账号</h2>
                <button class="modal-close" onclick="AccountCRUD.closeModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="accountForm" style="display: grid; gap: 20px;">
                    {% csrf_token %}
                    <input type="hidden" id="accountId" name="id">

                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px;">用户名 <span style="color: var(--error);">*</span></label>
                        <input type="text" id="accountUsername" name="username" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;">
                    </div>

                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px;">姓名</label>
                        <input type="text" id="accountFullName" name="first_name" style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;">
                    </div>

                    <div id="accountPasswordFieldGroup">
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px;">密码 <span style="color: var(--error);">*</span></label>
                        <input type="password" id="accountPassword" name="password" style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;">
                        <small style="color: var(--gray-500);">编辑时留空表示不修改密码</small>
                    </div>

                    <div id="accountPasswordConfirmFieldGroup">
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px;">确认密码 <span style="color: var(--error);">*</span></label>
                        <input type="password" id="accountPasswordConfirm" name="password_confirm" style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;">
                    </div>

                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px;">邮箱</label>
                        <input type="email" id="accountEmail" name="email" style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;">
                    </div>

                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px;">角色 <span style="color: var(--error);">*</span></label>
                        <select id="accountRole" name="role" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;">
                            <option value="super_admin">超级管理员</option>
                            <option value="admin">管理员</option>
                            <option value="finance">财务</option>
                            <option value="receptionist">前台</option>
                            <option value="engineering">工程部</option>
                            <option value="owner">业主</option>
                            <option value="tenant">租户</option>
                        </select>
                    </div>

                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px;">联系电话</label>
                        <input type="tel" id="accountPhone" name="phone" style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;">
                    </div>

                    <div>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="accountIsActive" name="is_active" checked style="width: 18px; height: 18px;">
                            <span style="font-size: 14px; font-weight: 500;">启用账号</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="AccountCRUD.closeModal()">取消</button>
                <button class="btn btn-primary" onclick="AccountCRUD.save()">保存</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    {% csrf_token %}
    <script src="{% static 'js/admin.js' %}"></script>
    <script>
        function switchAccountTab(tabElement, tabName) {
            const container = tabElement.closest('.tabs');
            const tabs = container.querySelectorAll('.tab');

            tabs.forEach(tab => tab.classList.remove('active'));
            tabElement.classList.add('active');

            const mainContent = document.querySelector('.content');
            const tabContents = mainContent.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.style.display = 'none';
            });

            const selectedTab = document.getElementById('tab-' + tabName);
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
        }

        const AccountCRUD = {
            api: {
                list: '/api/auth/users/',
                create: '/api/auth/users/',
                update: (id) => `/api/auth/users/${id}/`,
                delete: (id) => `/api/auth/users/${id}/`,
            },

            create() {
                document.getElementById('accountModalTitle').textContent = '创建账号';
                document.getElementById('accountForm').reset();
                document.getElementById('accountId').value = '';
                document.getElementById('accountPassword').required = true;
                document.getElementById('accountPasswordConfirm').required = true;
                document.getElementById('accountPasswordFieldGroup').style.display = 'block';
                document.getElementById('accountPasswordConfirmFieldGroup').style.display = 'block';
                const overlay = document.getElementById('accountModalOverlay');
                const modal = overlay.querySelector('.modal');
                overlay.style.display = 'flex';
                setTimeout(() => {
                    overlay.classList.add('show');
                    modal.classList.add('show');
                }, 10);
            },

            async edit(id) {
                try {
                    const response = await fetch(this.api.update(id));
                    if (!response.ok) {
                        throw new Error('获取用户信息失败');
                    }
                    const user = await response.json();

                    document.getElementById('accountModalTitle').textContent = '编辑账号';
                    document.getElementById('accountId').value = user.id;
                    document.getElementById('accountUsername').value = user.username;
                    document.getElementById('accountFullName').value = user.first_name || '';
                    document.getElementById('accountPassword').value = '';
                    document.getElementById('accountPasswordConfirm').value = '';
                    document.getElementById('accountPassword').required = false;
                    document.getElementById('accountPasswordConfirm').required = false;
                    document.getElementById('accountPasswordFieldGroup').style.display = 'none';
                    document.getElementById('accountPasswordConfirmFieldGroup').style.display = 'none';
                    document.getElementById('accountRole').value = user.role;
                    document.getElementById('accountPhone').value = user.phone || '';
                    document.getElementById('accountEmail').value = user.email || '';
                    document.getElementById('accountIsActive').checked = user.is_active;

                    const overlay = document.getElementById('accountModalOverlay');
                    const modal = overlay.querySelector('.modal');
                    overlay.style.display = 'flex';
                    setTimeout(() => {
                        overlay.classList.add('show');
                        modal.classList.add('show');
                    }, 10);
                } catch (e) {
                    alert('加载用户数据失败: ' + e.message);
                }
            },

            async save() {
                const form = document.getElementById('accountForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                const accountId = document.getElementById('accountId').value;
                const url = accountId ? this.api.update(accountId) : this.api.create;
                const method = accountId ? 'PUT' : 'POST';

                // 处理密码字段（编辑时为空则不发送）
                if (accountId && !data.password) {
                    delete data.password;
                    delete data.password_confirm;
                }

                // 处理复选框
                data.is_active = document.getElementById('accountIsActive').checked;

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        alert('保存成功');
                        location.reload();
                    } else {
                        const error = await response.json();
                        alert('保存失败: ' + JSON.stringify(error));
                    }
                } catch (e) {
                    alert('保存失败: ' + e.message);
                }
            },

            async delete(id) {
                if (!confirm('确定要删除此账号吗？')) return;

                try {
                    const response = await fetch(this.api.delete(id), {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
                        }
                    });

                    if (response.ok) {
                        alert('删除成功');
                        location.reload();
                    } else {
                        alert('删除失败');
                    }
                } catch (e) {
                    alert('删除失败: ' + e.message);
                }
            },

            viewRoleUsers(roleCode, roleName) {
                // 切换到账号列表Tab并筛选
                document.querySelectorAll('.tab').forEach(tab => {
                    if (tab.textContent.includes('账号列表')) {
                        tab.click();
                    }
                });
                const filter = document.getElementById('accountRoleFilter');
                filter.value = roleCode;
                AccountManager.filter();
            },

            toggleModulePermissions(moduleName, isChecked) {
                // 切换模块的所有权限复选框
                const checkboxes = document.querySelectorAll(`input[data-module="${moduleName}"]`);
                checkboxes.forEach(cb => {
                    cb.checked = isChecked;
                });
            },

            async loadPermissions(roleCode) {
                // 从API加载该角色的权限配置
                try {
                    const response = await fetch(`/api/auth/role-permissions/by_role/?role=${roleCode}`);
                    if (response.ok) {
                        const permissions = await response.json();
                        // 重置所有复选框
                        document.querySelectorAll('.permission-checkboxes input[type="checkbox"]').forEach(cb => {
                            cb.checked = false;
                        });
                        // 重置所有全选复选框
                        document.querySelectorAll('.select-all-module').forEach(cb => {
                            cb.checked = false;
                        });
                        // 根据返回的权限设置复选框
                        permissions.forEach(perm => {
                            const checkbox = document.querySelector(`input[data-permission="${perm.permission_code}"][data-action="${perm.action}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                        // 更新每个模块的全选复选框状态
                        this.updateSelectAllCheckboxes();
                    }
                } catch (e) {
                    console.error('加载权限失败:', e);
                }
            },

            updateSelectAllCheckboxes() {
                // 更新所有模块的全选复选框状态
                document.querySelectorAll('[data-module]').forEach(moduleDiv => {
                    // 跳过没有data-module属性的复选框容器
                    if (!moduleDiv.hasAttribute('data-module')) return;

                    const moduleName = moduleDiv.dataset.module;
                    const checkboxes = document.querySelectorAll(`input[data-module="${moduleName}"]`);
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    const selectAllCb = document.querySelector(`.select-all-module[data-module="${moduleName}"]`);
                    if (selectAllCb) {
                        selectAllCb.checked = allChecked && checkboxes.length > 0;
                    }
                });
            },

            async savePermissions() {
                const roleCode = document.getElementById('roleSelector').value;
                const permissions = [];

                // 收集所有选中的权限
                document.querySelectorAll('.permission-checkboxes input[type="checkbox"]:checked').forEach(cb => {
                    permissions.push({
                        permission_code: cb.dataset.permission,
                        action: cb.dataset.action
                    });
                });

                try {
                    const response = await fetch('/api/auth/role-permissions/bulk_update/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
                        },
                        body: JSON.stringify({
                            role: roleCode,
                            permissions: permissions
                        })
                    });

                    if (response.ok) {
                        alert('权限配置保存成功');
                    } else {
                        alert('保存失败');
                    }
                } catch (e) {
                    alert('保存失败: ' + e.message);
                }
            },

            closeModal() {
                const overlay = document.getElementById('accountModalOverlay');
                const modal = overlay.querySelector('.modal');
                overlay.classList.remove('show');
                modal.classList.remove('show');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 300);
            }
        };

        // 账号列表管理功能
        const AccountManager = {
            filter() {
                const searchValue = document.getElementById('accountSearchInput').value.toLowerCase();
                const roleFilter = document.getElementById('accountRoleFilter').value;
                const statusFilter = document.getElementById('accountStatusFilter').value;

                const rows = document.querySelectorAll('#accountsTableBody tr');
                rows.forEach(row => {
                    const username = row.dataset.username?.toLowerCase() || '';
                    const phone = row.dataset.phone?.toLowerCase() || '';
                    const role = row.dataset.role || '';
                    const isActive = row.dataset.isActive || '';

                    // 搜索匹配
                    const searchMatch = username.includes(searchValue) || phone.includes(searchValue);

                    // 角色筛选
                    const roleMatch = !roleFilter || role === roleFilter;

                    // 状态筛选
                    let statusMatch = true;
                    if (statusFilter === 'active') {
                        statusMatch = isActive === 'true';
                    } else if (statusFilter === 'inactive') {
                        statusMatch = isActive === 'false';
                    }

                    // 显示或隐藏行
                    row.style.display = searchMatch && roleMatch && statusMatch ? '' : 'none';
                });
            },

            reset() {
                document.getElementById('accountSearchInput').value = '';
                document.getElementById('accountRoleFilter').value = '';
                document.getElementById('accountStatusFilter').value = '';
                this.filter();
            },

            export() {
                const rows = document.querySelectorAll('#accountsTableBody tr:not([style*="display: none"])');
                if (rows.length === 0) {
                    alert('没有数据可导出');
                    return;
                }

                // CSV头部
                let csv = '\uFEFF'; // UTF-8 BOM
                csv += '用户名,姓名,角色,联系电话,邮箱,状态,创建时间\n';

                // CSV数据
                rows.forEach(row => {
                    const username = row.querySelector('td:nth-child(1) div:first-child')?.textContent || '';
                    const fullName = row.querySelector('td:nth-child(1) div:last-child')?.textContent || '';
                    const role = row.querySelector('td:nth-child(2) span')?.textContent || '';
                    const phone = row.querySelector('td:nth-child(3)')?.textContent || '';
                    const isActive = row.querySelector('td:nth-child(4) span')?.textContent || '';
                    const createdAt = row.querySelector('td:nth-child(5)')?.textContent || '';

                    // 清理数据
                    const cleanUsername = username.replace(/,/g, '，');
                    const cleanFullName = fullName.replace(/-/g, '').replace(/,/g, '，');
                    const cleanPhone = phone.replace(/-/g, '').replace(/,/g, '，');

                    csv += `"${cleanUsername}","${cleanFullName}","${role}","${cleanPhone}","${isActive}","${createdAt}"\n`;
                });

                // 下载CSV文件
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `账号列表_${new Date().toISOString().slice(0, 10)}.csv`;
                link.click();
            }
        };

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const accountModalOverlay = document.getElementById('accountModalOverlay');
            if (event.target === accountModalOverlay) {
                AccountCRUD.closeModal();
            }
        }

        // 页面加载时初始化：加载第一个角色的权限
        document.addEventListener('DOMContentLoaded', function() {
            const roleSelector = document.getElementById('roleSelector');
            if (roleSelector && roleSelector.value) {
                AccountCRUD.loadPermissions(roleSelector.value);
            }

            // 为所有权限复选框添加change事件监听器
            document.querySelectorAll('.permission-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const moduleName = this.dataset.module;
                    if (moduleName) {
                        AccountCRUD.updateSelectAllCheckboxes();
                    }
                });
            });
        });
    </script>
</body>
</html>

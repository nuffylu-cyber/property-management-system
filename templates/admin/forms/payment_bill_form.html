<form method="post" class="ajax-form" data-url="{{ form_url }}">
    {% csrf_token %}
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label class="form-label">所属小区 <span class="required">*</span></label>
                {{ form.community }}
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label class="form-label">房产 <span class="required">*</span></label>
                {{ form.property_unit }}
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label class="form-label">业主姓名 <span class="required">*</span></label>
                <input type="text" name="owner_name" class="form-control"
                       value="{% if form.instance.owner %}{{ form.instance.owner.name }}{% endif %}"
                       placeholder="请输入业主姓名" required>
                <input type="hidden" name="owner" value="{% if form.instance.owner %}{{ form.instance.owner.id }}{% endif %}">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-label">联系电话</label>
                <input type="text" class="form-control"
                       value="{% if form.instance.owner %}{{ form.instance.owner.phone }}{% else %}-{% endif %}"
                       readonly style="background-color: var(--gray-100);">
                <small style="color: var(--gray-500);">根据业主信息自动填充</small>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-label">身份证号</label>
                <input type="text" class="form-control"
                       value="{% if form.instance.owner %}{{ form.instance.owner.id_card }}{% else %}-{% endif %}"
                       readonly style="background-color: var(--gray-100);">
                <small style="color: var(--gray-500);">根据业主信息自动填充</small>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-label">费用类型 <span class="required">*</span></label>
                {{ form.fee_type }}
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-label">账期 <span class="required">*</span></label>
                {{ form.billing_period }}
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-label">应缴金额(元) <span class="required">*</span></label>
                {{ form.amount }}
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-label">应缴日期 <span class="required">*</span></label>
                {{ form.due_date }}
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="form-group">
                <label class="form-label">状态</label>
                {{ form.status }}
            </div>
        </div>
    </div>
    <div class="row" id="payment-fields-row" style="{% if form.instance.status == 'paid' or form.instance.status == 'partial' %}{% else %}display: none;{% endif %}">
        <div class="col-md-4">
            <div class="form-group">
                <label class="form-label">
                    支付方式
                    <span class="required" id="payment-method-required" style="{% if form.instance.status == 'paid' or form.instance.status == 'partial' %}{% else %}display: none;{% endif %}">*</span>
                </label>
                {{ form.payment_method }}
                <small style="color: var(--gray-500);">当状态为"已缴"或"部分缴"时必选</small>
                <small class="text-danger" id="payment-method-error" style="display: none;">请选择支付方式</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label class="form-label">缴费时间</label>
                <input type="datetime-local" name="paid_at" class="form-control" id="id_paid_at"
                       value="{% if form.instance.paid_at %}{{ form.instance.paid_at|date:'Y-m-d\TH:i:s' }}{% endif %}">
                <small style="color: var(--gray-500);">当状态为"已缴"或"部分缴"时自动填充</small>
            </div>
        </div>
        <div class="col-md-4" id="paid-amount-group" style="{% if form.instance.status == 'partial' %}{% else %}display: none;{% endif %}">
            <div class="form-group">
                <label class="form-label">
                    已缴金额(元)
                    <span class="required">*</span>
                </label>
                <input type="number" name="paid_amount_input" class="form-control" id="id_paid_amount_input"
                       value="{% if form.instance.paid_amount %}{{ form.instance.paid_amount }}{% endif %}"
                       step="0.01" min="0"
                       {% if form.instance.status == 'partial' %}required{% endif %}>
                <small style="color: var(--gray-500);">部分缴时必填，不能超过应缴金额</small>
                <small class="text-danger" id="paid-amount-error" style="display: none;">已缴金额不能超过应缴金额</small>
            </div>
        </div>
    </div>
    <div class="form-group">
        <label class="form-label">备注</label>
        {{ form.description }}
    </div>

<script>
// 监听状态变化，显示/隐藏支付方式和缴费时间字段
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('id_status');
    const paymentFieldsRow = document.getElementById('payment-fields-row');
    const paidAtInput = document.getElementById('id_paid_at');
    const paymentMethodRequired = document.getElementById('payment-method-required');
    const paymentMethodError = document.getElementById('payment-method-error');
    const paymentMethodSelect = document.getElementById('id_payment_method');
    const form = document.querySelector('.ajax-form');

    // 更新支付方式必填状态
    function updatePaymentMethodRequired(isRequired) {
        if (isRequired) {
            // 显示必填标记*
            if (paymentMethodRequired) {
                paymentMethodRequired.style.display = 'inline';
            }
            // 设置required属性
            if (paymentMethodSelect) {
                paymentMethodSelect.required = true;
            }
        } else {
            // 隐藏必填标记*
            if (paymentMethodRequired) {
                paymentMethodRequired.style.display = 'none';
            }
            // 移除required属性
            if (paymentMethodSelect) {
                paymentMethodSelect.required = false;
            }
            // 隐藏错误提示
            if (paymentMethodError) {
                paymentMethodError.style.display = 'none';
            }
        }
    }

    if (statusSelect && paymentFieldsRow) {
        statusSelect.addEventListener('change', function() {
            const status = this.value;

            if (status === 'paid' || status === 'partial') {
                // 显示支付方式和缴费时间字段
                paymentFieldsRow.style.display = 'flex';

                // 设置支付方式为必填
                updatePaymentMethodRequired(true);

                // 如果缴费时间为空，自动设置为当前时间
                if (!paidAtInput.value) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    const seconds = String(now.getSeconds()).padStart(2, '0');

                    paidAtInput.value = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
                }
            } else {
                // 隐藏支付方式和缴费时间字段
                paymentFieldsRow.style.display = 'none';
                // 清空支付方式和缴费时间
                if (paymentMethodSelect) {
                    paymentMethodSelect.value = '';
                }
                paidAtInput.value = '';
                // 取消支付方式必填
                updatePaymentMethodRequired(false);
            }
        });

        // 初始化：如果当前状态是已缴/部分缴，设置必填
        const initialStatus = statusSelect.value;
        if (initialStatus === 'paid' || initialStatus === 'partial') {
            updatePaymentMethodRequired(true);
        }
    }

    // 表单提交前验证
    if (form) {
        form.addEventListener('submit', function(e) {
            const status = statusSelect ? statusSelect.value : '';

            // 如果状态是已缴或部分缴，验证支付方式
            if ((status === 'paid' || status === 'partial') && paymentMethodSelect) {
                if (!paymentMethodSelect.value || paymentMethodSelect.value === '') {
                    e.preventDefault();
                    e.stopPropagation();

                    // 显示错误提示
                    if (paymentMethodError) {
                        paymentMethodError.style.display = 'block';
                        paymentMethodError.textContent = '请选择支付方式';
                    }

                    // 聚焦到支付方式选择框
                    paymentMethodSelect.focus();

                    return false;
                } else {
                    // 隐藏错误提示
                    if (paymentMethodError) {
                        paymentMethodError.style.display = 'none';
                    }
                }
            }
        });

        // 当用户选择支付方式时，隐藏错误提示
        if (paymentMethodSelect) {
            paymentMethodSelect.addEventListener('change', function() {
                if (this.value && paymentMethodError) {
                    paymentMethodError.style.display = 'none';
                }
            });
        }
    }
});
</script>
</form>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>缴费管理 - 物业管理系统</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" integrity="sha384-RGfTVqupv4ApPWeLYGbt6x8F8k4pbcQ52UPYH3u/trrA8zMHFFHgCxpQTsqeE" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/css/admin.css?v=1.0">
</head>
    <!-- SheetJS库 - 用于生成Excel文件 -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/admin/" class="logo">
                    <div class="logo-icon">
                        <i class="ri-building-4-line"></i>
                    </div>
                    <span>智慧物业</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">主菜单</div>
                    <a href="/admin/" class="nav-item" id="nav-dashboard">
                        <i class="ri-dashboard-line"></i>
                        <span>数据概览</span>
                    </a>
                    <a href="/admin/community/" class="nav-item" id="nav-community">
                        <i class="ri-community-line"></i>
                        <span>小区管理</span>
                    </a>
                    <a href="/admin/property/" class="nav-item" id="nav-property">
                        <i class="ri-home-4-line"></i>
                        <span>房产管理</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">业务管理</div>
                    <a href="/admin/payment/" class="nav-item" id="nav-payment">
                        <i class="ri-payment-line"></i>
                        <span>缴费管理</span>
                    </a>
                    <a href="/admin/maintenance/" class="nav-item" id="nav-maintenance">
                        <i class="ri-tools-line"></i>
                        <span>报事管理</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-card">
                    <div class="user-avatar">李</div>
                    <div class="user-info">
                        <div class="user-name">李明</div>
                        <div class="user-role">超级管理员</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <div class="breadcrumb">
                        <span class="breadcrumb-item">首页</span>
                        <span class="breadcrumb-separator"><i class="ri-arrow-right-s-line"></i></span>
                        <span class="breadcrumb-item active" id="breadcrumb-current">缴费管理</span>
                    </div>
                </div>

                <div class="header-right">
                    <div class="search-box">
                        <i class="ri-search-line"></i>
                        <input type="text" placeholder="搜索房产、业主、账单...">
                    </div>

                    <div class="header-actions">
                        <button class="icon-btn">
                            <i class="ri-notification-3-line"></i>
                        </button>
                        <button class="icon-btn">
                            <i class="ri-logout-box-r-line"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- 内容区域 -->
            <div class="content">
                
                <div class="page-header animate-in">
                    <div>
                        <h1 class="page-title">缴费管理</h1>
                        <p class="page-subtitle">费用标准、账单和缴费记录</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="FeeCRUD.addFeeStandard()">
                            <i class="ri-settings-3-line"></i>
                            费用设置
                        </button>
                        <button class="btn btn-primary" onclick="BillCRUD.addBill()">
                            <i class="ri-add-line"></i>
                            新增账单
                        </button>
                    </div>
                </div>

                <!-- Tab切换 -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab(this, 'bills')">
                        <i class="ri-file-list-3-line"></i>
                        账单列表
                    </button>
                    <button class="tab" onclick="switchTab(this, 'standards')">
                        <i class="ri-price-tag-3-line"></i>
                        费用标准
                    </button>
                    <button class="tab" onclick="switchTab(this, 'records')">
                        <i class="ri-history-line"></i>
                        缴费记录
                    </button>
                </div>

                <!-- 账单列表Tab -->
                <div id="tab-bills" class="tab-content">
                    <div class="table-container">
                        <div class="table-toolbar">
                            <div class="table-filters">
                                <div class="search-input">
                                    <i class="ri-search-line"></i>
                                    <input type="text" id="bill-search-input" placeholder="搜索账单编号、房号..." value="{{ search_query }}">
                                </div>
                                <select class="filter-select" id="bill-filter-community">
                                    <option value="">所有小区</option>
                                    {% for community in communities %}
                                    <option value="{{ community.id }}" {% if request.GET.community == community.id|stringformat:'s' %}selected{% endif %}>{{ community.name }}</option>
                                    {% endfor %}
                                </select>
                                <select class="filter-select" id="bill-filter-fee-type">
                                    <option value="">费用类型</option>
                                    <option value="property" {% if request.GET.fee_type == 'property' %}selected{% endif %}>物业费</option>
                                    <option value="public_electric" {% if request.GET.fee_type == 'public_electric' %}selected{% endif %}>公摊电费</option>
                                    <option value="water" {% if request.GET.fee_type == 'water' %}selected{% endif %}>水费</option>
                                    <option value="parking" {% if request.GET.fee_type == 'parking' %}selected{% endif %}>停车费</option>
                                    <option value="payable" {% if request.GET.fee_type == 'payable' %}selected{% endif %}>应缴费用</option>
                                    <option value="other" {% if request.GET.fee_type == 'other' %}selected{% endif %}>其他</option>
                                </select>
                                <select class="filter-select" id="bill-filter-status">
                                    <option value="">账单状态</option>
                                    <option value="unpaid" {% if request.GET.status == 'unpaid' %}selected{% endif %}>未缴</option>
                                    <option value="partial" {% if request.GET.status == 'partial' %}selected{% endif %}>部分缴</option>
                                    <option value="paid" {% if request.GET.status == 'paid' %}selected{% endif %}>已缴</option>
                                    <option value="overdue" {% if request.GET.status == 'overdue' %}selected{% endif %}>逾期</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="BillCRUD.importExcel()">
                                    <i class="ri-upload-2-line"></i>
                                    导入Excel
                                </button>
                                <button class="btn btn-secondary" onclick="BillManager.applyFilters()">
                                    <i class="ri-filter-3-line"></i>
                                    筛选
                                </button>
                                <button class="btn btn-secondary" style="color: var(--error); border-color: var(--error);" onclick="BillManager.batchDeleteBills()" id="batch-delete-bills-btn">
                                    <i class="ri-delete-bin-line"></i>
                                    批量删除
                                </button>
                            </div>
                        </div>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">
                                        <input type="checkbox" id="select-all-bills" onchange="BillManager.toggleSelectAll(this)">
                                    </th>
                                    <th>账单编号</th>
                                    <th>房号</th>
                                    <th>业主</th>
                                    <th>费用类型</th>
                                    <th>账期</th>
                                    <th>应缴金额</th>
                                    <th>实缴金额</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bill in bills %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="bill-checkbox" value="{{ bill.id }}" onchange="BillManager.toggleSelect(this)">
                                    </td>
                                    <td>
                                        <span style="font-family: monospace; font-weight: 600;">{{ bill.bill_number }}</span>
                                    </td>
                                    <td>
                                        <div style="font-weight: 600;">{{ bill.property_unit }}</div>
                                        <div style="font-size: 12px; color: var(--gray-400);">{{ bill.property_unit.floor_room_display }}</div>
                                    </td>
                                    <td>{{ bill.owner.name|default:"-" }}</td>
                                    <td><span class="tag tag-blue">{{ bill.get_fee_type_display }}</span></td>
                                    <td>{{ bill.billing_period }}</td>
                                    <td style="font-weight: 600;">¥{{ bill.amount }}</td>
                                    <td style="font-weight: 600; color: {% if bill.paid_amount == 0 %}var(--gray-400){% elif bill.paid_amount < bill.amount %}var(--warning){% else %}var(--success);{% endif %}">¥{{ bill.paid_amount }}</td>
                                    <td>
                                        {% if bill.status == 'paid' %}
                                            <span class="badge badge-success">已缴</span>
                                        {% elif bill.status == 'partial' %}
                                            <span class="badge badge-warning">部分缴</span>
                                        {% elif bill.status == 'overdue' %}
                                            <span class="badge badge-error">逾期</span>
                                        {% else %}
                                            <span class="badge badge-gray">未缴</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="action-btn edit" onclick="BillCRUD.editBill('{{ bill.id }}')">
                                                <i class="ri-eye-line"></i>
                                                查看
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px; color: var(--gray-500);">
                                        <i class="ri-inbox-line" style="font-size: 48px; display: block; margin-bottom: 10px;"></i>
                                        暂无账单数据，点击上方"新增账单"按钮添加
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <div class="table-pagination">
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: var(--space-md);">
                                <!-- 左侧：每页显示数量选择器 -->
                                <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                    <span style="font-size: 13px; color: var(--gray-600);">每页显示：</span>
                                    <select class="pagination-size-select" onchange="BillManager.changePageSize(this.value)">
                                        <option value="10" {% if page_size == 10 %}selected{% endif %}>10 条</option>
                                        <option value="20" {% if page_size == 20 %}selected{% endif %}>20 条</option>
                                        <option value="50" {% if page_size == 50 %}selected{% endif %}>50 条</option>
                                        <option value="100" {% if page_size == 100 %}selected{% endif %}>100 条</option>
                                    </select>
                                </div>

                                <!-- 中间：分页信息 -->
                                <div style="flex: 1; text-align: center;">
                                    <span style="font-size: 13px; color: var(--gray-600);">
                                        显示第 <strong>{{ bills.start_index }}-{{ bills.end_index }}</strong> 条，共 <strong>{{ bill_total }}</strong> 条记录
                                    </span>
                                </div>

                                <!-- 右侧：分页按钮 -->
                                <div class="pagination-controls">
                                    {% if bills.has_previous %}
                                    <a href="?page=1&page_size={{ page_size }}&community={{ request.GET.community }}&fee_type={{ request.GET.fee_type }}&status={{ request.GET.status }}&search={{ request.GET.search }}&tab=bills" class="page-btn" title="首页">
                                        首页
                                    </a>
                                    <a href="?page={{ bills.previous_page_number }}&page_size={{ page_size }}&community={{ request.GET.community }}&fee_type={{ request.GET.fee_type }}&status={{ request.GET.status }}&search={{ request.GET.search }}&tab=bills" class="page-btn" title="上一页">
                                        上一页
                                    </a>
                                    {% else %}
                                    <button class="page-btn" disabled title="首页">
                                        首页
                                    </button>
                                    <button class="page-btn" disabled title="上一页">
                                        上一页
                                    </button>
                                    {% endif %}

                                    <span class="page-indicator">
                                        <strong>{{ bills.number }}</strong> / {{ bills.paginator.num_pages }}
                                    </span>

                                    {% if bills.has_next %}
                                    <a href="?page={{ bills.next_page_number }}&page_size={{ page_size }}&community={{ request.GET.community }}&fee_type={{ request.GET.fee_type }}&status={{ request.GET.status }}&search={{ request.GET.search }}&tab=bills" class="page-btn" title="下一页">
                                        下一页
                                    </a>
                                    <a href="?page={{ bills.paginator.num_pages }}&page_size={{ page_size }}&community={{ request.GET.community }}&fee_type={{ request.GET.fee_type }}&status={{ request.GET.status }}&search={{ request.GET.search }}&tab=bills" class="page-btn" title="末页">
                                        末页
                                    </a>
                                    {% else %}
                                    <button class="page-btn" disabled title="下一页">
                                        下一页
                                    </button>
                                    <button class="page-btn" disabled title="末页">
                                        末页
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 费用标准Tab -->
                <div id="tab-standards" class="tab-content" style="display: none;">
                    <div class="table-container">
                        <div class="table-toolbar">
                            <div class="table-filters">
                                <select class="filter-select" id="fee-filter-community">
                                    <option value="">所有小区</option>
                                    {% for community in communities %}
                                    <option value="{{ community.id }}" {% if request.GET.community == community.id|stringformat:'s' %}selected{% endif %}>{{ community.name }}</option>
                                    {% endfor %}
                                </select>
                                <select class="filter-select" id="fee-filter-type">
                                    <option value="">费用类型</option>
                                    <option value="property" {% if request.GET.fee_type == 'property' %}selected{% endif %}>物业费</option>
                                    <option value="public_electric" {% if request.GET.fee_type == 'public_electric' %}selected{% endif %}>公摊电费</option>
                                    <option value="water" {% if request.GET.fee_type == 'water' %}selected{% endif %}>水费</option>
                                    <option value="parking" {% if request.GET.fee_type == 'parking' %}selected{% endif %}>停车费</option>
                                    <option value="payable" {% if request.GET.fee_type == 'payable' %}selected{% endif %}>应缴费用</option>
                                    <option value="other" {% if request.GET.fee_type == 'other' %}selected{% endif %}>其他</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-primary" onclick="FeeCRUD.addFeeStandard()">
                                    <i class="ri-add-line"></i>
                                    新增标准
                                </button>
                                <button class="btn btn-secondary" onclick="FeeManager.applyFilters()">
                                    <i class="ri-filter-3-line"></i>
                                    筛选
                                </button>
                                <button class="btn btn-secondary" style="color: var(--error); border-color: var(--error);" onclick="FeeManager.batchDeleteFeeStandards()" id="batch-delete-fees-btn">
                                    <i class="ri-delete-bin-line"></i>
                                    批量删除
                                </button>
                            </div>
                        </div>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">
                                        <input type="checkbox" id="select-all-fees" onchange="FeeManager.toggleSelectAll(this)">
                                    </th>
                                    <th>费用名称</th>
                                    <th>所属小区</th>
                                    <th>费用类型</th>
                                    <th>单价(元/㎡/月)</th>
                                    <th>计费周期</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for standard in standards %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="fee-checkbox" value="{{ standard.id }}" onchange="FeeManager.toggleSelect(this)">
                                    </td>
                                    <td>
                                        <div style="font-weight: 600;">{{ standard.name }}</div>
                                    </td>
                                    <td>{{ standard.community.name|default:"-" }}</td>
                                    <td>
                                        {% if standard.fee_type == 'property' %}
                                            <span class="tag tag-blue">物业费</span>
                                        {% elif standard.fee_type == 'parking' %}
                                            <span class="tag tag-gray">停车费</span>
                                        {% elif standard.fee_type == 'public_electric' %}
                                            <span class="tag tag-green">公摊电费</span>
                                        {% elif standard.fee_type == 'water' %}
                                            <span class="tag tag-blue">水费</span>
                                        {% elif standard.fee_type == 'payable' %}
                                            <span class="tag tag-purple">应缴费用</span>
                                        {% else %}
                                            <span class="tag">{{ standard.get_fee_type_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td style="font-weight: 600; color: var(--primary-600);">¥{{ standard.unit_price }}</td>
                                    <td>{{ standard.get_billing_cycle_display }}</td>
                                    <td>
                                        {% if standard.is_active %}
                                            <span class="badge badge-success">启用</span>
                                        {% else %}
                                            <span class="badge badge-gray">停用</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="action-btn edit" onclick="FeeCRUD.editFeeStandard('{{ standard.id }}')">
                                                <i class="ri-edit-line"></i>
                                                编辑
                                            </button>
                                            <button class="action-btn delete" onclick="FeeCRUD.deleteFeeStandard('{{ standard.id }}', '{{ standard.name }}')">
                                                <i class="ri-delete-bin-line"></i>
                                                删除
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px; color: var(--gray-500);">
                                        <i class="ri-inbox-line" style="font-size: 48px; display: block; margin-bottom: 10px;"></i>
                                        暂无费用标准数据，点击上方"新增标准"按钮添加
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <div class="table-pagination">
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: var(--space-md);">
                                <!-- 左侧：每页显示数量选择器 -->
                                <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                    <span style="font-size: 13px; color: var(--gray-600);">每页显示：</span>
                                    <select class="pagination-size-select" onchange="StandardManager.changePageSize(this.value)">
                                        <option value="10" {% if page_size == 10 %}selected{% endif %}>10 条</option>
                                        <option value="20" {% if page_size == 20 %}selected{% endif %}>20 条</option>
                                        <option value="50" {% if page_size == 50 %}selected{% endif %}>50 条</option>
                                        <option value="100" {% if page_size == 100 %}selected{% endif %}>100 条</option>
                                    </select>
                                </div>

                                <!-- 中间：分页信息 -->
                                <div style="flex: 1; text-align: center;">
                                    <span style="font-size: 13px; color: var(--gray-600);">
                                        显示第 <strong>{{ standards.start_index }}-{{ standards.end_index }}</strong> 条，共 <strong>{{ standard_total }}</strong> 条记录
                                    </span>
                                </div>

                                <!-- 右侧：分页按钮 -->
                                <div class="pagination-controls">
                                    {% if standards.has_previous %}
                                    <a href="?page=1&page_size={{ page_size }}&community={{ request.GET.community }}&fee_type={{ request.GET.fee_type }}&tab=standards" class="page-btn" title="首页">
                                        首页
                                    </a>
                                    <a href="?page={{ standards.previous_page_number }}&page_size={{ page_size }}&community={{ request.GET.community }}&fee_type={{ request.GET.fee_type }}&tab=standards" class="page-btn" title="上一页">
                                        上一页
                                    </a>
                                    {% else %}
                                    <button class="page-btn" disabled title="首页">
                                        首页
                                    </button>
                                    <button class="page-btn" disabled title="上一页">
                                        上一页
                                    </button>
                                    {% endif %}

                                    <span class="page-indicator">
                                        <strong>{{ standards.number }}</strong> / {{ standards.paginator.num_pages }}
                                    </span>

                                    {% if standards.has_next %}
                                    <a href="?page={{ standards.next_page_number }}&page_size={{ page_size }}&community={{ request.GET.community }}&fee_type={{ request.GET.fee_type }}&tab=standards" class="page-btn" title="下一页">
                                        下一页
                                    </a>
                                    <a href="?page={{ standards.paginator.num_pages }}&page_size={{ page_size }}&community={{ request.GET.community }}&fee_type={{ request.GET.fee_type }}&tab=standards" class="page-btn" title="末页">
                                        末页
                                    </a>
                                    {% else %}
                                    <button class="page-btn" disabled title="下一页">
                                        下一页
                                    </button>
                                    <button class="page-btn" disabled title="末页">
                                        末页
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 缴费记录Tab -->
                <div id="tab-records" class="tab-content" style="display: none;">
                    <div class="table-container">
                        <div class="table-toolbar">
                            <div class="table-filters">
                                <div class="search-input">
                                    <i class="ri-search-line"></i>
                                    <input type="text" id="record-search-input" placeholder="搜索交易号、房号..." value="{{ search_query }}">
                                </div>
                                <select class="filter-select" id="record-filter-community">
                                    <option value="">所有小区</option>
                                    {% for community in communities %}
                                    <option value="{{ community.id }}" {% if request.GET.community == community.id|stringformat:'s' %}selected{% endif %}>{{ community.name }}</option>
                                    {% endfor %}
                                </select>
                                <select class="filter-select" id="record-filter-method">
                                    <option value="">支付方式</option>
                                    <option value="wechat" {% if request.GET.payment_method == 'wechat' %}selected{% endif %}>微信支付</option>
                                    <option value="alipay" {% if request.GET.payment_method == 'alipay' %}selected{% endif %}>支付宝</option>
                                    <option value="cash" {% if request.GET.payment_method == 'cash' %}selected{% endif %}>现金</option>
                                    <option value="bank_transfer" {% if request.GET.payment_method == 'bank_transfer' %}selected{% endif %}>银行转账</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="RecordManager.applyFilters()">
                                    <i class="ri-filter-3-line"></i>
                                    筛选
                                </button>
                                <button class="btn btn-secondary" style="color: var(--error); border-color: var(--error);" onclick="RecordManager.batchDeleteRecords()" id="batch-delete-records-btn">
                                    <i class="ri-delete-bin-line"></i>
                                    批量删除
                                </button>
                            </div>
                        </div>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">
                                        <input type="checkbox" id="select-all-records" onchange="RecordManager.toggleSelectAll(this)">
                                    </th>
                                    <th>交易号</th>
                                    <th>房号</th>
                                    <th>业主</th>
                                    <th>缴费金额</th>
                                    <th>支付方式</th>
                                    <th>缴费时间</th>
                                    <th>操作人</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in records %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="record-checkbox" value="{{ record.id }}" onchange="RecordManager.toggleSelect(this)">
                                    </td>
                                    <td>
                                        <span style="font-family: monospace; font-size: 12px;">{{ record.transaction_id }}</span>
                                    </td>
                                    <td>
                                        <div style="font-weight: 600;">{{ record.bill.property_unit }}</div>
                                        <div style="font-size: 12px; color: var(--gray-400);">{{ record.bill.property_unit.floor_room_display }}</div>
                                    </td>
                                    <td>{{ record.bill.owner.name|default:"-" }}</td>
                                    <td style="font-weight: 600; color: var(--success);">¥{{ record.amount }}</td>
                                    <td>
                                        {% if record.payment_method == 'wechat' %}
                                            <span class="tag tag-green">微信支付</span>
                                        {% elif record.payment_method == 'alipay' %}
                                            <span class="tag tag-blue">支付宝</span>
                                        {% elif record.payment_method == 'cash' %}
                                            <span class="tag tag-gray">现金</span>
                                        {% elif record.payment_method == 'bank_transfer' %}
                                            <span class="tag tag-purple">银行转账</span>
                                        {% else %}
                                            <span class="tag">{{ record.get_payment_method_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ record.payment_time|date:"Y-m-d H:i:s" }}</td>
                                    <td>{{ record.operator|default:"-" }}</td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="action-btn edit" onclick="RecordCRUD.viewRecord('{{ record.id }}')">
                                                <i class="ri-eye-line"></i>
                                                详情
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px; color: var(--gray-500);">
                                        <i class="ri-inbox-line" style="font-size: 48px; display: block; margin-bottom: 10px;"></i>
                                        暂无缴费记录
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <div class="table-pagination">
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: var(--space-md);">
                                <!-- 左侧：每页显示数量选择器 -->
                                <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                    <span style="font-size: 13px; color: var(--gray-600);">每页显示：</span>
                                    <select class="pagination-size-select" onchange="RecordManager.changePageSize(this.value)">
                                        <option value="10" {% if page_size == 10 %}selected{% endif %}>10 条</option>
                                        <option value="20" {% if page_size == 20 %}selected{% endif %}>20 条</option>
                                        <option value="50" {% if page_size == 50 %}selected{% endif %}>50 条</option>
                                        <option value="100" {% if page_size == 100 %}selected{% endif %}>100 条</option>
                                    </select>
                                </div>

                                <!-- 中间：分页信息 -->
                                <div style="flex: 1; text-align: center;">
                                    <span style="font-size: 13px; color: var(--gray-600);">
                                        显示第 <strong>{{ records.start_index }}-{{ records.end_index }}</strong> 条，共 <strong>{{ record_total }}</strong> 条记录
                                    </span>
                                </div>

                                <!-- 右侧：分页按钮 -->
                                <div class="pagination-controls">
                                    {% if records.has_previous %}
                                    <a href="?page=1&page_size={{ page_size }}&community={{ request.GET.community }}&payment_method={{ request.GET.payment_method }}&search={{ request.GET.search }}&tab=records" class="page-btn" title="首页">
                                        首页
                                    </a>
                                    <a href="?page={{ records.previous_page_number }}&page_size={{ page_size }}&community={{ request.GET.community }}&payment_method={{ request.GET.payment_method }}&search={{ request.GET.search }}&tab=records" class="page-btn" title="上一页">
                                        上一页
                                    </a>
                                    {% else %}
                                    <button class="page-btn" disabled title="首页">
                                        首页
                                    </button>
                                    <button class="page-btn" disabled title="上一页">
                                        上一页
                                    </button>
                                    {% endif %}

                                    <span class="page-indicator">
                                        <strong>{{ records.number }}</strong> / {{ records.paginator.num_pages }}
                                    </span>

                                    {% if records.has_next %}
                                    <a href="?page={{ records.next_page_number }}&page_size={{ page_size }}&community={{ request.GET.community }}&payment_method={{ request.GET.payment_method }}&search={{ request.GET.search }}&tab=records" class="page-btn" title="下一页">
                                        下一页
                                    </a>
                                    <a href="?page={{ records.paginator.num_pages }}&page_size={{ page_size }}&community={{ request.GET.community }}&payment_method={{ request.GET.payment_method }}&search={{ request.GET.search }}&tab=records" class="page-btn" title="末页">
                                        末页
                                    </a>
                                    {% else %}
                                    <button class="page-btn" disabled title="下一页">
                                        下一页
                                    </button>
                                    <button class="page-btn" disabled title="末页">
                                        末页
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            
            </div>
        </main>
    </div>

    <!-- 标签页工具函数 -->
    <script src="/static/js/tab-utils.js?v=1.0"></script>
    <!-- 通用CRUD管理器 -->
    <script src="/static/js/universal-crud.js?v=2.5"></script>
    <!-- 缴费管理CRUD模块 -->
    <script src="/static/js/payment-crud.js?v=3.1"></script>
    <script src="/static/js/admin.js?v=2.2"></script>

    <script>
    // 设置当前页面的active状态
    document.addEventListener('DOMContentLoaded', function() {
        const currentPath = window.location.pathname;

        // 移除所有active类
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });

        // 添加active类到当前页面的导航项
        if (currentPath === '/admin/') {
            document.getElementById('nav-dashboard')?.classList.add('active');
        } else if (currentPath === '/admin/community/') {
            document.getElementById('nav-community')?.classList.add('active');
        } else if (currentPath === '/admin/property/') {
            document.getElementById('nav-property')?.classList.add('active');
        } else if (currentPath === '/admin/payment/') {
            document.getElementById('nav-payment')?.classList.add('active');

            // 检查URL参数中的tab，自动切换到对应的标签页
            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('tab');
            const action = urlParams.get('action');

            if (activeTab) {
                const tabElement = document.querySelector(`.tab[onclick*="switchTab(this, '${activeTab}')"]`);
                if (tabElement) {
                    switchTab(tabElement, activeTab);
                }
            }

            // 处理action参数
            console.log('[Payment Page] Checking action parameter:', action);
            console.log('[Payment Page] typeof BillCRUD:', typeof BillCRUD);
            console.log('[Payment Page] typeof BillCRUD.addBill:', typeof BillCRUD !== 'undefined' ? typeof BillCRUD.addBill : 'N/A');

            if (action === 'add') {
                console.log('[Payment Page] Action is "add", attempting to open add form...');

                // 先切换到账单标签页
                if (activeTab === 'bills') {
                    console.log('[Payment Page] Switching to bills tab first');
                    const tabElement = document.querySelector(`.tab[onclick*="switchTab(this, 'bills')"]`);
                    if (tabElement) {
                        switchTab(tabElement, 'bills');
                    }
                }

                // 延迟执行以确保标签页已切换完成
                setTimeout(() => {
                    console.log('[Payment Page] Timeout fired, checking BillCRUD again...');
                    console.log('[Payment Page] typeof BillCRUD:', typeof BillCRUD);

                    if (typeof BillCRUD !== 'undefined' && typeof BillCRUD.addBill === 'function') {
                        console.log('[Payment Page] ✓ Calling BillCRUD.addBill()');
                        try {
                            BillCRUD.addBill();
                            console.log('[Payment Page] ✓ addBill() called successfully');
                        } catch (e) {
                            console.error('[Payment Page] ✗ Error calling addBill:', e);
                        }
                    } else {
                        console.error('[Payment Page] ✗ BillCRUD or addBill not available');
                    }
                }, 500);
            }

            // 初始化所有搜索功能
            if (typeof BillManager !== 'undefined' && BillManager.setupSearch) {
                BillManager.setupSearch();
            }
            if (typeof RecordManager !== 'undefined' && RecordManager.setupSearch) {
                RecordManager.setupSearch();
            }
        } else if (currentPath === '/admin/maintenance/') {
            document.getElementById('nav-maintenance')?.classList.add('active');
        }

        // 初始化分页信息
        BillManager.updatePagination();
        StandardManager.updatePagination();
        RecordManager.updatePagination();
    });

    // Tab切换功能
    function switchTab(tabElement, tabName) {
        const container = tabElement.closest('.tabs');
        const tabs = container.querySelectorAll('.tab');

        tabs.forEach(tab => tab.classList.remove('active'));
        tabElement.classList.add('active');

        const mainContent = document.querySelector('.content');
        const tabContents = mainContent.querySelectorAll('.tab-content');
        tabContents.forEach(content => {
            content.style.display = 'none';
        });

        const selectedTab = document.getElementById('tab-' + tabName);
        if (selectedTab) {
            selectedTab.style.display = 'block';
        }
    }

    // 账单管理器
    const BillManager = {
        currentPage: 1,
        pageSize: 10,
        totalItems: {{ bills|length }},

        updatePagination() {
            const total = this.totalItems;
            const start = 1;
            const end = total;

            document.getElementById('billsStart').textContent = start;
            document.getElementById('billsEnd').textContent = end;
            document.getElementById('billsTotal').textContent = total;

            document.getElementById('billsPrevBtn').disabled = true;
            document.getElementById('billsNextBtn').disabled = true;
        },

        // 改变每页显示数量
        changePageSize(pageSize) {
            const searchInput = document.getElementById('bill-search-input');
            const searchValue = searchInput ? searchInput.value.trim() : '';
            const community = document.getElementById('bill-filter-community')?.value || '';
            const feeType = document.getElementById('bill-filter-fee-type')?.value || '';
            const status = document.getElementById('bill-filter-status')?.value || '';

            const url = new URL(window.location);
            url.searchParams.set('page', '1');
            url.searchParams.set('page_size', pageSize);
            url.searchParams.set('tab', 'bills');

            // 保留搜索条件
            if (searchValue) {
                url.searchParams.set('search', searchValue);
            } else {
                url.searchParams.delete('search');
            }

            // 保留筛选条件
            if (community) {
                url.searchParams.set('community', community);
            } else {
                url.searchParams.delete('community');
            }
            if (feeType) {
                url.searchParams.set('fee_type', feeType);
            } else {
                url.searchParams.delete('fee_type');
            }
            if (status) {
                url.searchParams.set('status', status);
            } else {
                url.searchParams.delete('status');
            }

            window.location.href = url.toString();
        },

        // 实时搜索功能
        setupSearch() {
            const searchInput = document.getElementById('bill-search-input');
            if (!searchInput) return;

            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const searchValue = e.target.value.trim();

                // 延迟1000ms后执行搜索，避免频繁请求
                searchTimeout = setTimeout(() => {
                    const url = new URL(window.location);
                    url.searchParams.set('page', '1');
                    url.searchParams.set('tab', 'bills');

                    // 获取当前筛选条件
                    const community = document.getElementById('bill-filter-community')?.value || '';
                    const feeType = document.getElementById('bill-filter-fee-type')?.value || '';
                    const status = document.getElementById('bill-filter-status')?.value || '';

                    // 保留搜索条件
                    if (searchValue) {
                        url.searchParams.set('search', searchValue);
                    } else {
                        url.searchParams.delete('search');
                    }

                    // 保留筛选条件
                    if (community) {
                        url.searchParams.set('community', community);
                    } else {
                        url.searchParams.delete('community');
                    }
                    if (feeType) {
                        url.searchParams.set('fee_type', feeType);
                    } else {
                        url.searchParams.delete('fee_type');
                    }
                    if (status) {
                        url.searchParams.set('status', status);
                    } else {
                        url.searchParams.delete('status');
                    }

                    window.location.href = url.toString();
                }, 1000); // 延迟1000ms（1秒）
            });
        },

        // 应用筛选条件
        applyFilters() {
            const community = document.getElementById('bill-filter-community').value;
            const feeType = document.getElementById('bill-filter-fee-type').value;
            const status = document.getElementById('bill-filter-status').value;
            const searchInput = document.getElementById('bill-search-input');
            const searchValue = searchInput ? searchInput.value.trim() : '';

            const url = new URL(window.location);
            url.searchParams.set('page', '1');
            url.searchParams.set('tab', 'bills');

            // 设置筛选参数
            if (community) url.searchParams.set('community', community);
            else url.searchParams.delete('community');

            if (feeType) url.searchParams.set('fee_type', feeType);
            else url.searchParams.delete('fee_type');

            if (status) url.searchParams.set('status', status);
            else url.searchParams.delete('status');

            if (searchValue) url.searchParams.set('search', searchValue);
            else url.searchParams.delete('search');

            window.location.href = url.toString();
        },

        prevPage() {
            return;
        },

        nextPage() {
            return;
        },

        // 全选/取消全选
        toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.bill-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        },

        toggleSelect(checkbox) {
            // 可以在这里添加逻辑，比如更新选中数量
        },

        // 批量删除账单
        async batchDeleteBills() {
            const checkboxes = document.querySelectorAll('.bill-checkbox:checked');

            if (checkboxes.length === 0) {
                alert('请先选择要删除的账单');
                return;
            }

            const billIds = Array.from(checkboxes).map(cb => cb.value);

            const confirmed = confirm(`确定要删除选中的 ${billIds.length} 个账单吗？\n\n此操作无法恢复！`);
            if (!confirmed) return;

            try {
                // 获取CSRF token
                const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]')?.content ||
                                  document.querySelector('meta[name="csrf-token"]')?.content ||
                                  document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;

                // 发送批量删除请求
                const response = await fetch('/api/payment/bills/batch_delete/', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        bill_ids: billIds
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    // 刷新页面以显示更新后的数据
                    window.location.reload();
                } else {
                    alert('删除失败：' + (result.error || '未知错误'));
                }
            } catch (error) {
                console.error('批量删除错误:', error);
                alert('删除失败：网络错误或服务器异常');
            }
        }
    };

    // 费用标准管理器
    const StandardManager = {
        currentPage: 1,
        pageSize: 10,
        totalItems: {{ standards|length }},

        updatePagination() {
            const total = this.totalItems;
            const start = 1;
            const end = total;

            document.getElementById('standardsStart').textContent = start;
            document.getElementById('standardsEnd').textContent = end;
            document.getElementById('standardsTotal').textContent = total;

            document.getElementById('standardsPrevBtn').disabled = true;
            document.getElementById('standardsNextBtn').disabled = true;
        },

        // 改变每页显示数量
        changePageSize(pageSize) {
            const community = document.getElementById('fee-filter-community')?.value || '';
            const feeType = document.getElementById('fee-filter-type')?.value || '';

            const url = new URL(window.location);
            url.searchParams.set('page', '1');
            url.searchParams.set('page_size', pageSize);
            url.searchParams.set('tab', 'standards');

            // 保留筛选条件
            if (community) {
                url.searchParams.set('community', community);
            } else {
                url.searchParams.delete('community');
            }
            if (feeType) {
                url.searchParams.set('fee_type', feeType);
            } else {
                url.searchParams.delete('fee_type');
            }

            window.location.href = url.toString();
        },

        // 应用筛选条件
        applyFilters() {
            const community = document.getElementById('fee-filter-community').value;
            const feeType = document.getElementById('fee-filter-type').value;

            const url = new URL(window.location);
            url.searchParams.set('page', '1');
            url.searchParams.set('tab', 'standards');

            // 设置筛选参数
            if (community) url.searchParams.set('community', community);
            else url.searchParams.delete('community');

            if (feeType) url.searchParams.set('fee_type', feeType);
            else url.searchParams.delete('fee_type');

            window.location.href = url.toString();
        },

        prevPage() {
            return;
        },

        nextPage() {
            return;
        },

        // 全选/取消全选
        toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.fee-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        },

        toggleSelect(checkbox) {
            // 可以在这里添加逻辑，比如更新选中数量
        },

        // 批量删除费用标准
        async batchDeleteFeeStandards() {
            const checkboxes = document.querySelectorAll('.fee-checkbox:checked');

            if (checkboxes.length === 0) {
                alert('请先选择要删除的费用标准');
                return;
            }

            const standardIds = Array.from(checkboxes).map(cb => cb.value);

            const confirmed = confirm(`确定要删除选中的 ${standardIds.length} 个费用标准吗？\n\n此操作无法恢复！`);
            if (!confirmed) return;

            try {
                const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]')?.content ||
                                  document.querySelector('meta[name="csrf-token"]')?.content ||
                                  document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;

                const response = await fetch('/api/payment/fee-standards/batch_delete/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        standard_ids: standardIds
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    window.location.reload();
                } else {
                    alert('删除失败：' + (result.error || '未知错误'));
                }
            } catch (error) {
                console.error('批量删除错误:', error);
                alert('删除失败：网络错误或服务器异常');
            }
        }
    };

    // 缴费记录管理器
    const RecordManager = {
        currentPage: 1,
        pageSize: 10,
        totalItems: {{ records|length }},

        updatePagination() {
            const total = this.totalItems;
            const start = 1;
            const end = total;

            document.getElementById('recordsStart').textContent = start;
            document.getElementById('recordsEnd').textContent = end;
            document.getElementById('recordsTotal').textContent = total;

            document.getElementById('recordsPrevBtn').disabled = true;
            document.getElementById('recordsNextBtn').disabled = true;
        },

        // 改变每页显示数量
        changePageSize(pageSize) {
            const searchInput = document.getElementById('record-search-input');
            const searchValue = searchInput ? searchInput.value.trim() : '';
            const community = document.getElementById('record-filter-community')?.value || '';
            const paymentMethod = document.getElementById('record-filter-method')?.value || '';

            const url = new URL(window.location);
            url.searchParams.set('page', '1');
            url.searchParams.set('page_size', pageSize);
            url.searchParams.set('tab', 'records');

            // 保留搜索条件
            if (searchValue) {
                url.searchParams.set('search', searchValue);
            } else {
                url.searchParams.delete('search');
            }

            // 保留筛选条件
            if (community) {
                url.searchParams.set('community', community);
            } else {
                url.searchParams.delete('community');
            }
            if (paymentMethod) {
                url.searchParams.set('payment_method', paymentMethod);
            } else {
                url.searchParams.delete('payment_method');
            }

            window.location.href = url.toString();
        },

        // 实时搜索功能
        setupSearch() {
            const searchInput = document.getElementById('record-search-input');
            if (!searchInput) return;

            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const searchValue = e.target.value.trim();

                // 延迟1000ms后执行搜索，避免频繁请求
                searchTimeout = setTimeout(() => {
                    const url = new URL(window.location);
                    url.searchParams.set('page', '1');
                    url.searchParams.set('tab', 'records');

                    // 获取当前筛选条件
                    const community = document.getElementById('record-filter-community')?.value || '';
                    const paymentMethod = document.getElementById('record-filter-method')?.value || '';

                    // 保留搜索条件
                    if (searchValue) {
                        url.searchParams.set('search', searchValue);
                    } else {
                        url.searchParams.delete('search');
                    }

                    // 保留筛选条件
                    if (community) {
                        url.searchParams.set('community', community);
                    } else {
                        url.searchParams.delete('community');
                    }
                    if (paymentMethod) {
                        url.searchParams.set('payment_method', paymentMethod);
                    } else {
                        url.searchParams.delete('payment_method');
                    }

                    window.location.href = url.toString();
                }, 1000); // 延迟1000ms（1秒）
            });
        },

        // 应用筛选条件
        applyFilters() {
            const community = document.getElementById('record-filter-community').value;
            const paymentMethod = document.getElementById('record-filter-method').value;
            const searchInput = document.getElementById('record-search-input');
            const searchValue = searchInput ? searchInput.value.trim() : '';

            const url = new URL(window.location);
            url.searchParams.set('page', '1');
            url.searchParams.set('tab', 'records');

            // 设置筛选参数
            if (community) url.searchParams.set('community', community);
            else url.searchParams.delete('community');

            if (paymentMethod) url.searchParams.set('payment_method', paymentMethod);
            else url.searchParams.delete('payment_method');

            if (searchValue) url.searchParams.set('search', searchValue);
            else url.searchParams.delete('search');

            window.location.href = url.toString();
        },

        prevPage() {
            return;
        },

        nextPage() {
            return;
        },

        // 全选/取消全选
        toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.record-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        },

        toggleSelect(checkbox) {
            // 可以在这里添加逻辑，比如更新选中数量
        },

        // 批量删除缴费记录
        async batchDeleteRecords() {
            const checkboxes = document.querySelectorAll('.record-checkbox:checked');

            if (checkboxes.length === 0) {
                alert('请先选择要删除的缴费记录');
                return;
            }

            const recordIds = Array.from(checkboxes).map(cb => cb.value);

            const confirmed = confirm(`确定要删除选中的 ${recordIds.length} 条缴费记录吗？\n\n此操作无法恢复！`);
            if (!confirmed) return;

            try {
                const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]')?.content ||
                                  document.querySelector('meta[name="csrf-token"]')?.content ||
                                  document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;

                const response = await fetch('/api/payment/records/batch_delete/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        record_ids: recordIds
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    window.location.reload();
                } else {
                    alert('删除失败：' + (result.error || '未知错误'));
                }
            } catch (error) {
                console.error('批量删除错误:', error);
                alert('删除失败：网络错误或服务器异常');
            }
        }
    };
</script>
</body>
</html>
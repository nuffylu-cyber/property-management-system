{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理 - 物业管理系统</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/admin.css' %}">
</head>
<body>
    <div class="app-container">
        <!-- 侧边栏 -->
        {% include "components/sidebar.html" %}

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 顶部栏 -->
            {% include "components/header.html" %}

            <!-- 内容区域 -->
            <div class="content">
                <!-- 页面头部 -->
                <div class="page-header animate-in">
                    <div>
                        <h1 class="page-title">用户管理</h1>
                        <p class="page-subtitle">管理系统用户和权限</p>
                    </div>
                    <button class="btn btn-primary" onclick="UserCRUD.create()">
                        <i class="ri-add-line"></i>
                        新增用户
                    </button>
                </div>

                <!-- 统计卡片 -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div style="background: #fff; border-radius: var(--radius-lg); padding: 16px; box-shadow: var(--shadow-sm);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <span style="font-size: 13px; color: var(--gray-500);">全部用户</span>
                            <div style="width: 32px; height: 32px; border-radius: var(--radius-md); background: var(--primary-50); color: var(--primary-600); display: flex; align-items: center; justify-content: center;">
                                <i class="ri-user-line"></i>
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">{{ total_users }}</div>
                    </div>

                    <div style="background: #fff; border-radius: var(--radius-lg); padding: 16px; box-shadow: var(--shadow-sm);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <span style="font-size: 13px; color: var(--gray-500);">管理员</span>
                            <div style="width: 32px; height: 32px; border-radius: var(--radius-md); background: var(--error-light); color: var(--error); display: flex; align-items: center; justify-content: center;">
                                <i class="ri-admin-line"></i>
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">{{ admin_count }}</div>
                    </div>

                    <div style="background: #fff; border-radius: var(--radius-lg); padding: 16px; box-shadow: var(--shadow-sm);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <span style="font-size: 13px; color: var(--gray-500);">活跃用户</span>
                            <div style="width: 32px; height: 32px; border-radius: var(--radius-md); background: var(--success-light); color: var(--success); display: flex; align-items: center; justify-content: center;">
                                <i class="ri-check-line"></i>
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">{{ active_users_count }}</div>
                    </div>

                    <div style="background: #fff; border-radius: var(--radius-lg); padding: 16px; box-shadow: var(--shadow-sm);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <span style="font-size: 13px; color: var(--gray-500);">本月新增</span>
                            <div style="width: 32px; height: 32px; border-radius: var(--radius-md); background: var(--info-light); color: var(--info); display: flex; align-items: center; justify-content: center;">
                                <i class="ri-user-add-line"></i>
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">5</div>
                    </div>
                </div>

                <!-- Tab切换 -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab(this, 'users-list')">
                        <i class="ri-list-check"></i>
                        用户列表
                    </button>
                    <button class="tab" onclick="switchTab(this, 'roles')">
                        <i class="ri-shield-key-line"></i>
                        角色权限
                    </button>
                </div>

                <!-- 用户列表Tab -->
                <div id="tab-users-list" class="tab-content">
                    <div class="table-container">
                        <div class="table-toolbar">
                            <div class="table-filters">
                                <div class="search-input">
                                    <i class="ri-search-line"></i>
                                    <input type="text" id="userSearchInput" placeholder="搜索用户名、手机号..." onkeyup="UserManager.filterUsers()">
                                </div>
                                <select class="filter-select" id="userRoleFilter" onchange="UserManager.filterUsers()">
                                    <option value="">所有角色</option>
                                    <option value="super_admin">超级管理员</option>
                                    <option value="admin">管理员</option>
                                    <option value="finance">财务</option>
                                    <option value="receptionist">前台</option>
                                    <option value="engineering">工程部</option>
                                    <option value="owner">业主</option>
                                    <option value="tenant">租户</option>
                                </select>
                                <select class="filter-select" id="userStatusFilter" onchange="UserManager.filterUsers()">
                                    <option value="">所有状态</option>
                                    <option value="active">活跃</option>
                                    <option value="inactive">禁用</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="UserManager.resetFilters()">
                                    <i class="ri-refresh-line"></i>
                                    重置
                                </button>
                                <button class="btn btn-secondary" onclick="UserManager.exportUsers()">
                                    <i class="ri-download-line"></i>
                                    导出
                                </button>
                            </div>
                        </div>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th>用户名</th>
                                    <th>姓名</th>
                                    <th>角色</th>
                                    <th>手机号</th>
                                    <th>邮箱</th>
                                    <th>状态</th>
                                    <th>最后登录</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                {% for user in users %}
                                <tr data-user-id="{{ user.id }}" data-username="{{ user.username }}" data-role="{{ user.role }}" data-phone="{{ user.phone|default:'' }}" data-is-active="{{ user.is_active|lower }}">
                                    <td>
                                        <div style="font-weight: 600;">{{ user.username }}</div>
                                        <div style="font-size: 12px; color: var(--gray-400);">ID: {{ user.id|slice:":8" }}</div>
                                    </td>
                                    <td>{{ user.get_full_name|default:user.username }}</td>
                                    <td><span class="tag tag-blue">{{ user.get_role_display }}</span></td>
                                    <td>{{ user.phone|default:"-" }}</td>
                                    <td>{{ user.email|default:"-" }}</td>
                                    <td>
                                        {% if user.is_active %}
                                        <span class="tag tag-green">活跃</span>
                                        {% else %}
                                        <span class="tag tag-gray">禁用</span>
                                        {% endif %}
                                    </td>
                                    <td style="font-size: 12px; color: var(--gray-500);">
                                        {% if user.last_login %}
                                        {{ user.last_login|date:"Y-m-d H:i" }}
                                        {% else %}
                                        从未登录
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="action-btn edit" onclick="UserCRUD.edit('{{ user.id }}')">
                                                <i class="ri-edit-line"></i>
                                                编辑
                                            </button>
                                            {% if user.username != request.user.username %}
                                            <button class="action-btn delete" onclick="UserCRUD.delete('{{ user.id }}')">
                                                <i class="ri-delete-bin-line"></i>
                                                删除
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px; color: var(--gray-500);">
                                        <i class="ri-inbox-line" style="font-size: 48px; display: block; margin-bottom: 16px;"></i>
                                        暂无用户数据
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <div class="table-pagination">
                            <div class="pagination-info">
                                显示 1-{{ users|length }} 条，共 {{ users|length }} 条记录
                            </div>
                            <div class="pagination-controls">
                                <button class="page-btn" disabled>
                                    <i class="ri-arrow-left-s-line"></i>
                                </button>
                                <button class="page-btn active">1</button>
                                <button class="page-btn">
                                    <i class="ri-arrow-right-s-line"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 角色权限Tab -->
                <div id="tab-roles" class="tab-content" style="display: none;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 24px;">
                        <!-- 超级管理员 -->
                        <div style="background: #fff; border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border-left: 4px solid var(--error);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: var(--error-light); color: var(--error); display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                    <i class="ri-shield-keyhole-line"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 16px; font-weight: 600; margin: 0;">超级管理员</h3>
                                    <p style="font-size: 12px; color: var(--gray-500); margin: 0;">super_admin</p>
                                </div>
                            </div>
                            <p style="font-size: 13px; color: var(--gray-600); line-height: 1.6;">拥有系统所有权限，可以管理所有模块、创建账号、配置系统参数</p>
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                                <div style="font-size: 13px; color: var(--gray-500);">用户数量</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">{{ admin_count }}</div>
                            </div>
                        </div>

                        <!-- 管理员 -->
                        <div style="background: #fff; border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border-left: 4px solid var(--warning);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: var(--warning-light); color: var(--warning); display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                    <i class="ri-admin-line"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 16px; font-weight: 600; margin: 0;">管理员</h3>
                                    <p style="font-size: 12px; color: var(--gray-500); margin: 0;">admin</p>
                                </div>
                            </div>
                            <p style="font-size: 13px; color: var(--gray-600); line-height: 1.6;">可以管理小区、房产、报事等信息，但不能操作系统设置和账号管理</p>
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                                <div style="font-size: 13px; color: var(--gray-500);">用户数量</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">{{ admin_count }}</div>
                            </div>
                        </div>

                        <!-- 财务 -->
                        <div style="background: #fff; border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border-left: 4px solid var(--info);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: var(--info-light); color: var(--info); display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                    <i class="ri-money-cny-circle-line"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 16px; font-weight: 600; margin: 0;">财务</h3>
                                    <p style="font-size: 12px; color: var(--gray-500); margin: 0;">finance</p>
                                </div>
                            </div>
                            <p style="font-size: 13px; color: var(--gray-600); line-height: 1.6;">可以查看和管理缴费信息、生成账单、查看财务报表</p>
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                                <div style="font-size: 13px; color: var(--gray-500);">用户数量</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">-</div>
                            </div>
                        </div>

                        <!-- 前台 -->
                        <div style="background: #fff; border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border-left: 4px solid var(--primary-600);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: var(--primary-50); color: var(--primary-600); display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                    <i class="ri-service-line"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 16px; font-weight: 600; margin: 0;">前台</h3>
                                    <p style="font-size: 12px; color: var(--gray-500); margin: 0;">receptionist</p>
                                </div>
                            </div>
                            <p style="font-size: 13px; color: var(--gray-600); line-height: 1.6;">负责日常接待、接听报事电话、登记报事信息、查看业主信息</p>
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                                <div style="font-size: 13px; color: var(--gray-500);">用户数量</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">-</div>
                            </div>
                        </div>

                        <!-- 工程部 -->
                        <div style="background: #fff; border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border-left: 4px solid var(--success);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: var(--success-light); color: var(--success); display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                    <i class="ri-tools-line"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 16px; font-weight: 600; margin: 0;">工程部</h3>
                                    <p style="font-size: 12px; color: var(--gray-500); margin: 0;">engineering</p>
                                </div>
                            </div>
                            <p style="font-size: 13px; color: var(--gray-600); line-height: 1.6;">查看和处理报事工单、更新维修进度、完成维修任务</p>
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                                <div style="font-size: 13px; color: var(--gray-500);">用户数量</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">-</div>
                            </div>
                        </div>

                        <!-- 业主 -->
                        <div style="background: #fff; border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border-left: 4px solid var(--gray-500);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: var(--gray-100); color: var(--gray-600); display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                    <i class="ri-home-user-line"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 16px; font-weight: 600; margin: 0;">业主</h3>
                                    <p style="font-size: 12px; color: var(--gray-500); margin: 0;">owner</p>
                                </div>
                            </div>
                            <p style="font-size: 13px; color: var(--gray-600); line-height: 1.6;">查看个人房产信息、缴费记录、提交报事申请</p>
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                                <div style="font-size: 13px; color: var(--gray-500);">用户数量</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">{{ owner_count }}</div>
                            </div>
                        </div>

                        <!-- 租户 -->
                        <div style="background: #fff; border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border-left: 4px solid var(--accent-600);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: var(--accent-100); color: var(--accent-700); display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                    <i class="ri-user-smile-line"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 16px; font-weight: 600; margin: 0;">租户</h3>
                                    <p style="font-size: 12px; color: var(--gray-500); margin: 0;">tenant</p>
                                </div>
                            </div>
                            <p style="font-size: 13px; color: var(--gray-600); line-height: 1.6;">查看个人房产信息、缴费记录、提交报事申请</p>
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                                <div style="font-size: 13px; color: var(--gray-500);">用户数量</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--gray-900);">{{ tenant_count }}</div>
                            </div>
                        </div>

                        <!-- 权限说明 -->
                        <div style="grid-column: span 4; background: linear-gradient(135deg, var(--primary-50) 0%, var(--info-light) 100%); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm);">
                            <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 16px 0; color: var(--gray-900);">
                                <i class="ri-information-line" style="color: var(--primary-600);"></i>
                                权限说明
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                                <div>
                                    <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--gray-900);">数据管理</h4>
                                    <ul style="font-size: 13px; color: var(--gray-600); margin: 0; padding-left: 20px;">
                                        <li>查看：所有角色都可以查看数据</li>
                                        <li>编辑：管理员及以上可编辑</li>
                                        <li>删除：仅超级管理员和管理员</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--gray-900);">业务权限</h4>
                                    <ul style="font-size: 13px; color: var(--gray-600); margin: 0; padding-left: 20px;">
                                        <li>缴费管理：财务专属</li>
                                        <li>报事处理：工程部和前台</li>
                                        <li>房产管理：管理员和前台</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--gray-900);">系统权限</h4>
                                    <ul style="font-size: 13px; color: var(--gray-600); margin: 0; padding-left: 20px;">
                                        <li>用户管理：仅超级管理员</li>
                                        <li>系统设置：仅超级管理员</li>
                                        <li>支付配置：超级管理员和财务</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 用户模态框 -->
    <div id="userModalOverlay" class="modal-overlay">
        <div class="modal modal-md">
            <div class="modal-header">
                <h2 class="modal-title" id="userModalTitle">新增用户</h2>
                <button class="modal-close" onclick="UserCRUD.closeModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="userForm" style="display: grid; gap: 20px;">
                    {% csrf_token %}
                    <input type="hidden" id="userId" name="id">

                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px;">用户名 <span style="color: var(--error);">*</span></label>
                        <input type="text" id="userUsername" name="username" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;">
                    </div>

                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px;">姓名</label>
                        <input type="text" id="userFirstName" name="first_name" style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;">
                    </div>

                    <div id="passwordFieldGroup">
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px;">密码 <span style="color: var(--error);">*</span></label>
                        <input type="password" id="userPassword" name="password" style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;">
                        <small style="color: var(--gray-500);">编辑时留空表示不修改密码</small>
                    </div>

                    <div id="passwordConfirmFieldGroup">
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px;">确认密码 <span style="color: var(--error);">*</span></label>
                        <input type="password" id="userPasswordConfirm" name="password_confirm" style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;">
                    </div>

                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px;">角色 <span style="color: var(--error);">*</span></label>
                        <select id="userRole" name="role" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;">
                            <option value="super_admin">超级管理员</option>
                            <option value="admin">管理员</option>
                            <option value="finance">财务</option>
                            <option value="receptionist">前台</option>
                            <option value="engineering">工程部</option>
                            <option value="owner">业主</option>
                            <option value="tenant">租户</option>
                        </select>
                    </div>

                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px;">手机号</label>
                        <input type="tel" id="userPhone" name="phone" style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;">
                    </div>

                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px;">邮箱</label>
                        <input type="email" id="userEmail" name="email" style="width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-size: 14px;">
                    </div>

                    <div>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="userIsActive" name="is_active" checked style="width: 18px; height: 18px;">
                            <span style="font-size: 14px; font-weight: 500;">启用账号</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="UserCRUD.closeModal()">取消</button>
                <button class="btn btn-primary" onclick="UserCRUD.save()">保存</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    {% csrf_token %}
    <script src="{% static 'js/admin.js' %}"></script>
    <script>
        // Tab切换功能
        function switchTab(tabElement, tabName) {
            const container = tabElement.closest('.tabs');
            const tabs = container.querySelectorAll('.tab');

            tabs.forEach(tab => tab.classList.remove('active'));
            tabElement.classList.add('active');

            const mainContent = document.querySelector('.content');
            const tabContents = mainContent.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.style.display = 'none';
            });

            const selectedTab = document.getElementById('tab-' + tabName);
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
        }

        // 用户CRUD功能
        const UserCRUD = {
            api: {
                list: '/api/auth/users/',
                create: '/api/auth/users/',
                update: (id) => `/api/auth/users/${id}/`,
                delete: (id) => `/api/auth/users/${id}/`,
            },

            create() {
                document.getElementById('userModalTitle').textContent = '新增用户';
                document.getElementById('userForm').reset();
                document.getElementById('userId').value = '';
                document.getElementById('userPassword').required = true;
                document.getElementById('userPasswordConfirm').required = true;
                document.getElementById('passwordFieldGroup').style.display = 'block';
                document.getElementById('passwordConfirmFieldGroup').style.display = 'block';
                const overlay = document.getElementById('userModalOverlay');
                const modal = overlay.querySelector('.modal');
                overlay.style.display = 'flex';
                // 强制重绘以确保transition生效
                setTimeout(() => {
                    overlay.classList.add('show');
                    modal.classList.add('show');
                }, 10);
            },

            async edit(id) {
                try {
                    const response = await fetch(this.api.update(id));
                    if (!response.ok) {
                        throw new Error('获取用户信息失败');
                    }
                    const user = await response.json();

                    document.getElementById('userModalTitle').textContent = '编辑用户';
                    document.getElementById('userId').value = user.id;
                    document.getElementById('userUsername').value = user.username;
                    document.getElementById('userFirstName').value = user.first_name || '';
                    document.getElementById('userPassword').value = '';
                    document.getElementById('userPasswordConfirm').value = '';
                    document.getElementById('userPassword').required = false;
                    document.getElementById('userPasswordConfirm').required = false;
                    document.getElementById('passwordFieldGroup').style.display = 'none';
                    document.getElementById('passwordConfirmFieldGroup').style.display = 'none';
                    document.getElementById('userRole').value = user.role;
                    document.getElementById('userPhone').value = user.phone || '';
                    document.getElementById('userEmail').value = user.email || '';
                    document.getElementById('userIsActive').checked = user.is_active;

                    const overlay = document.getElementById('userModalOverlay');
                    const modal = overlay.querySelector('.modal');
                    overlay.style.display = 'flex';
                    // 强制重绘以确保transition生效
                    setTimeout(() => {
                        overlay.classList.add('show');
                        modal.classList.add('show');
                    }, 10);
                } catch (e) {
                    alert('加载用户数据失败: ' + e.message);
                }
            },

            async save() {
                const form = document.getElementById('userForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                const userId = document.getElementById('userId').value;
                const url = userId ? this.api.update(userId) : this.api.create;
                const method = userId ? 'PUT' : 'POST';

                // 处理密码字段（编辑时为空则不发送）
                if (userId && !data.password) {
                    delete data.password;
                }

                // 处理复选框
                data.is_active = document.getElementById('userIsActive').checked;

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        alert('保存成功');
                        location.reload();
                    } else {
                        const error = await response.json();
                        const errorMessages = Object.entries(error)
                            .map(([key, value]) => `${key}: ${Array.isArray(value) ? value.join(', ') : value}`)
                            .join('\n');
                        alert('保存失败:\n' + errorMessages);
                    }
                } catch (e) {
                    alert('保存失败: ' + e.message);
                }
            },

            async delete(id) {
                if (!confirm('确定要删除此用户吗？删除后无法恢复！')) return;

                try {
                    const response = await fetch(this.api.delete(id), {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
                        }
                    });

                    if (response.ok) {
                        alert('删除成功');
                        location.reload();
                    } else {
                        const error = await response.json();
                        alert('删除失败: ' + JSON.stringify(error));
                    }
                } catch (e) {
                    alert('删除失败: ' + e.message);
                }
            },

            closeModal() {
                const overlay = document.getElementById('userModalOverlay');
                const modal = overlay.querySelector('.modal');
                overlay.classList.remove('show');
                modal.classList.remove('show');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 300);
            }
        };

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const overlay = document.getElementById('userModalOverlay');
            if (event.target === overlay) {
                UserCRUD.closeModal();
            }
        }

        // 用户管理功能
        const UserManager = {
            filterUsers() {
                const searchText = document.getElementById('userSearchInput').value.toLowerCase();
                const roleFilter = document.getElementById('userRoleFilter').value;
                const statusFilter = document.getElementById('userStatusFilter').value;
                const tbody = document.getElementById('usersTableBody');
                const rows = tbody.getElementsByTagName('tr');

                let visibleCount = 0;

                for (let row of rows) {
                    const username = row.getAttribute('data-username')?.toLowerCase() || '';
                    const phone = row.getAttribute('data-phone')?.toLowerCase() || '';
                    const role = row.getAttribute('data-role') || '';
                    const isActive = row.getAttribute('data-is-active') || '';

                    // 搜索文本匹配
                    const matchesSearch = !searchText || username.includes(searchText) || phone.includes(searchText);

                    // 角色筛选
                    const matchesRole = !roleFilter || role === roleFilter;

                    // 状态筛选
                    const matchesStatus = !statusFilter ||
                        (statusFilter === 'active' && isActive === 'true') ||
                        (statusFilter === 'inactive' && isActive === 'false');

                    if (matchesSearch && matchesRole && matchesStatus) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                }

                // 更新分页信息
                const paginationInfo = document.querySelector('.pagination-info');
                if (paginationInfo) {
                    paginationInfo.textContent = `显示 ${visibleCount} 条记录`;
                }
            },

            resetFilters() {
                document.getElementById('userSearchInput').value = '';
                document.getElementById('userRoleFilter').value = '';
                document.getElementById('userStatusFilter').value = '';
                this.filterUsers();
            },

            exportUsers() {
                // 获取所有可见的用户数据
                const rows = document.querySelectorAll('#usersTableBody tr:not([style*="display: none"])');
                const users = [];

                rows.forEach(row => {
                    const cells = row.getElementsByTagName('td');
                    users.push({
                        username: cells[0].textContent.trim(),
                        name: cells[1].textContent.trim(),
                        role: cells[2].textContent.trim(),
                        phone: cells[3].textContent.trim(),
                        email: cells[4].textContent.trim(),
                        status: cells[5].textContent.trim(),
                        lastLogin: cells[6].textContent.trim()
                    });
                });

                // 生成CSV
                const headers = ['用户名', '姓名', '角色', '手机号', '邮箱', '状态', '最后登录'];
                const csvContent = [
                    headers.join(','),
                    ...users.map(u => [
                        `"${u.username}"`,
                        `"${u.name}"`,
                        `"${u.role}"`,
                        `"${u.phone}"`,
                        `"${u.email}"`,
                        `"${u.status}"`,
                        `"${u.lastLogin}"`
                    ].join(','))
                ].join('\n');

                // 创建下载
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `用户列表_${new Date().toLocaleDateString('zh-CN')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert(`已导出 ${users.length} 条用户数据`);
            }
        };
    </script>
</body>
</html>
